<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Elevate - Professional Training</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        /* ========== RESET & BASE ========== */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body {
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.5;
        }
        #root { height: 100%; }

        /* ========== LAYOUT ========== */
        .app {
            display: grid;
            grid-template-columns: 1fr;
            grid-template-rows: auto 1fr;
            height: 100%;
            overflow: hidden;
        }
        .app.with-sidebar {
            grid-template-columns: 320px 1fr;
            grid-template-rows: 100vh;
            height: 100vh;
            overflow: hidden;
        }
        .app.with-sidebar .header { display: none; }

        /* ========== HEADER (Home Page) ========== */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 32px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
        }
        .header-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #38bdf8;
        }
        .header-brand span { font-size: 1.5rem; }
        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* ========== SIDEBAR ========== */
        .sidebar {
            display: flex;
            flex-direction: column;
            background: #1e293b;
            border-right: 1px solid #334155;
            height: 100vh;
            min-height: 0;
        }
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #334155;
            flex-shrink: 0;
        }
        .sidebar-brand {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .sidebar-brand-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            font-weight: 600;
            color: #38bdf8;
        }
        .sidebar-brand-text span { font-size: 1.1rem; }
        .back-home {
            padding: 6px 10px;
            background: transparent;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .back-home:hover { background: #334155; color: #e2e8f0; }
        .course-select {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .course-select:focus { outline: none; border-color: #38bdf8; }

        .sidebar-nav {
            flex: 1 1 auto;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            min-height: 0;
        }
        .nav-section { margin-bottom: 20px; }
        .nav-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            padding: 0 8px;
            margin-bottom: 8px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 4px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #cbd5e1;
            font-size: 0.875rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
        }
        .nav-item:hover { background: #334155; }
        .nav-item.active { background: #0ea5e9; color: white; }
        .nav-item-icon { font-size: 1rem; }
        .nav-item-label { flex: 1; }
        .nav-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        .badge-slides { background: #0ea5e9; color: white; }
        .badge-lab { background: #8b5cf6; color: white; }
        .badge-demo { background: #f43f5e; color: white; }
        .badge-notes { background: #eab308; color: #1e293b; }
        .badge-run { background: #22c55e; color: white; margin-left: 4px; }
        .badge-pdf { background: #3b82f6; color: white; margin-left: 4px; }
        .badge-live { background: #a855f7; color: white; margin-left: 4px; }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid #334155;
            flex-shrink: 0;
        }
        .download-all-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid #38bdf8;
            border-radius: 6px;
            color: #38bdf8;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .download-all-btn:hover { background: rgba(56, 189, 248, 0.1); }

        /* ========== MAIN CONTENT ========== */
        .main {
            background: #0f172a;
            height: 100%;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: #1e293b;
            border-bottom: 1px solid #334155;
            flex-shrink: 0;
        }
        .content-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: #e2e8f0;
        }
        .content-actions { display: flex; gap: 8px; }

        .content-body {
            flex: 1;
            overflow: auto;
        }
        .content-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* ========== HOME PAGE ========== */
        .home {
            flex: 1;
            overflow-y: auto;
            padding: 48px 32px;
        }
        .home-hero {
            max-width: 600px;
            margin: 0 auto 48px;
            text-align: center;
        }
        .home-hero-icon { font-size: 4rem; margin-bottom: 16px; }
        .home-hero h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 12px;
        }
        .home-hero p {
            font-size: 1.1rem;
            color: #94a3b8;
        }
        .home-tagline {
            font-size: 1.25rem;
            color: #64748b;
            font-weight: 500;
        }
        .home-cta {
            margin-top: 40px;
        }
        .btn-lg {
            padding: 14px 32px;
            font-size: 1rem;
        }
        .course-picker {
            padding: 14px 20px;
            font-size: 1rem;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 8px;
            color: #e2e8f0;
            min-width: 300px;
            cursor: pointer;
        }
        .course-picker:focus {
            outline: none;
            border-color: #38bdf8;
        }
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .course-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .course-card:hover {
            border-color: #38bdf8;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        }
        .course-card-icon { font-size: 2.5rem; margin-bottom: 12px; }
        .course-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }
        .course-card p {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 12px;
        }
        .course-card-duration {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* ========== TOPIC GRID (Homepage) ========== */
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            padding: 2rem 0;
            max-width: 1200px;
            margin: 0 auto;
        }
        .topic-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 2rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
            border: 1px solid #334155;
            text-align: center;
        }
        .topic-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
            border-color: #38bdf8;
        }
        .topic-card-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        .topic-card-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 0.5rem;
        }
        .topic-card-description {
            color: #94a3b8;
            font-size: 0.95rem;
            margin-bottom: 1rem;
        }
        .topic-card-count {
            background: #0ea5e9;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.85rem;
            display: inline-block;
        }

        /* ========== CATEGORY PAGE ========== */
        .category-page-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        .category-page-icon {
            font-size: 2.5rem;
        }
        .category-page-info {
            flex: 1;
        }
        .category-page-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
        }
        .category-page-desc {
            color: #94a3b8;
            font-size: 0.95rem;
            margin-top: 4px;
        }
        .back-button {
            background: none;
            border: 1px solid #475569;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            color: #38bdf8;
            transition: background 0.2s;
        }
        .back-button:hover {
            background: #334155;
        }

        /* ========== COURSE WELCOME ========== */
        .course-welcome {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            text-align: center;
            overflow-y: auto;
        }
        .course-welcome-icon { font-size: 4rem; margin-bottom: 16px; }
        .course-welcome h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f1f5f9;
            margin-bottom: 12px;
        }
        .course-welcome p {
            font-size: 1rem;
            color: #94a3b8;
            max-width: 500px;
            margin-bottom: 24px;
        }
        .stats-row {
            display: flex;
            gap: 24px;
            margin-top: 32px;
        }
        .stat-box {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px 32px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #38bdf8;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-top: 4px;
        }

        /* ========== BUTTONS ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
        }
        .btn-ghost {
            background: transparent;
            border: 1px solid #475569;
            color: #e2e8f0;
        }
        .btn-ghost:hover { background: #334155; }
        .btn-primary {
            background: #0ea5e9;
            color: white;
        }
        .btn-primary:hover { background: #0284c7; }
        .btn-success {
            background: #22c55e;
            color: white;
        }
        .btn-success:hover { background: #16a34a; }

        /* ========== USER ========== */
        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #0ea5e9;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .user-name {
            font-size: 0.875rem;
            color: #e2e8f0;
        }
        .guest-label {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* ========== AUTH MODAL ========== */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 16px;
            padding: 32px;
            width: 100%;
            max-width: 400px;
        }
        .modal h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f1f5f9;
            text-align: center;
            margin-bottom: 24px;
        }
        .modal-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #334155;
        }
        .modal-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.875rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        .modal-tab.active {
            color: #38bdf8;
            border-bottom-color: #38bdf8;
        }
        .form-group { margin-bottom: 16px; }
        .form-group label {
            display: block;
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        .form-group input {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.875rem;
        }
        .form-group input:focus {
            outline: none;
            border-color: #38bdf8;
        }
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input {
            padding-right: 40px;
        }
        .password-toggle {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            padding: 4px;
            font-size: 1.1rem;
            line-height: 1;
            display: flex;
            align-items: center;
        }
        .password-toggle:hover {
            color: #e2e8f0;
        }
        .form-error {
            color: #f43f5e;
            font-size: 0.875rem;
            text-align: center;
            margin-top: 12px;
        }
        .modal-footer {
            text-align: center;
            margin-top: 16px;
        }
        .modal-footer button {
            background: none;
            border: none;
            color: #64748b;
            font-size: 0.875rem;
            cursor: pointer;
        }
        .modal-footer button:hover { color: #94a3b8; }

        /* ========== ADMIN MODAL ========== */
        .admin-modal {
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .admin-modal h2 {
            text-align: left;
            margin-bottom: 16px;
        }
        .admin-btn {
            background: none;
            border: 1px solid #475569;
            color: #94a3b8;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.15s;
        }
        .admin-btn:hover {
            background: #334155;
            color: #e2e8f0;
        }
        .admin-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        .admin-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.875rem;
            font-family: inherit;
        }
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #38bdf8;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group .hint {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 4px;
        }
        .admin-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            margin-bottom: 16px;
        }
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-top: 12px;
        }
        .admin-table th {
            text-align: left;
            padding: 8px 10px;
            background: #0f172a;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #334155;
        }
        .admin-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #1e293b;
            color: #e2e8f0;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        .admin-table tr:hover td {
            background: rgba(56, 189, 248, 0.05);
        }
        .copy-all-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        .copy-all-btn:hover {
            background: #475569;
        }
        .admin-success {
            color: #22c55e;
            font-size: 0.875rem;
            margin-bottom: 12px;
        }
        .admin-errors {
            color: #f43f5e;
            font-size: 0.8rem;
            margin-bottom: 12px;
        }
        .admin-errors li {
            margin-left: 16px;
            list-style: disc;
        }
        .admin-section {
            border-top: 1px solid #334155;
            padding-top: 16px;
            margin-top: 16px;
        }
        .admin-section-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .admin-inline-form {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }
        .admin-inline-form input {
            flex: 1;
            padding: 7px 10px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.8rem;
        }
        .admin-inline-form input:focus {
            outline: none;
            border-color: #38bdf8;
        }
        .admin-delete-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 1rem;
            padding: 2px 6px;
            border-radius: 4px;
            line-height: 1;
            transition: all 0.15s;
        }
        .admin-delete-btn:hover {
            color: #f43f5e;
            background: rgba(244, 63, 94, 0.1);
        }
        .instructor-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: #1e3a5f;
            border: 1px solid #2563eb;
            border-radius: 20px;
            color: #93c5fd;
            font-size: 0.8rem;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .instructor-chip button {
            background: none;
            border: none;
            color: #93c5fd;
            cursor: pointer;
            font-size: 0.85rem;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.15s;
        }
        .instructor-chip button:hover {
            opacity: 1;
            color: #f43f5e;
        }
        .btn-sm {
            padding: 5px 12px;
            font-size: 0.75rem;
            border-radius: 5px;
        }
        .admin-table-wrapper {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #1e293b;
            border-radius: 6px;
        }
        .admin-table-wrapper .admin-table {
            margin-top: 0;
        }
        .admin-table-wrapper .admin-table thead th {
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .admin-empty {
            color: #64748b;
            font-style: italic;
            font-size: 0.8rem;
            padding: 8px 0;
        }
        .instructor-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #93c5fd;
            font-size: 0.875rem;
        }
        .fill-blank {
            background: #1e293b;
            border: none;
            border-bottom: 2px solid #475569;
            color: #e2e8f0;
            font-size: inherit;
            font-family: inherit;
            padding: 2px 4px;
            min-width: 80px;
            outline: none;
            transition: border-color 0.15s;
        }
        .fill-blank:focus {
            border-bottom-color: #38bdf8;
        }
        .fill-blank-wide {
            min-width: 200px;
            width: 60%;
        }
        td .fill-blank {
            width: 100%;
            min-width: 40px;
        }
        blockquote .fill-blank {
            width: 90%;
            min-width: 200px;
        }
        .exercise-submit-wrapper {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
            text-align: center;
        }
        .exercise-submit-btn {
            background: linear-gradient(135deg, #2563eb, #7c3aed);
            color: white;
            border: none;
            padding: 10px 28px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .exercise-submit-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(37,99,235,0.4); }
        .exercise-submit-btn:disabled { opacity: 0.6; cursor: wait; transform: none; }
        .ai-review-cell {
            background: linear-gradient(135deg, rgba(37,99,235,0.08), rgba(124,58,237,0.08));
            border-left: 3px solid #7c3aed;
            padding: 1rem;
            border-radius: 8px;
        }

        /* ========== LOADING ========== */
        .loading-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 16px;
            color: #64748b;
        }
        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid #334155;
            border-top-color: #38bdf8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ========== NOTEBOOK ========== */
        .notebook-container {
            padding: 24px;
            background: #0f172a;
        }
        .main.ai-panel-open { overflow: hidden; }
        .main.ai-panel-open .notebook-container {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }
        .main::-webkit-scrollbar {
            width: 10px;
        }
        .main::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .main::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 5px;
        }
        .main::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        .notebook-toolbar-container {
            background: linear-gradient(180deg, #1e293b 0%, #172033 100%);
            border-bottom: 1px solid #334155;
            flex-shrink: 0;
        }
        .toolbar-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 16px;
            cursor: pointer;
            user-select: none;
        }
        .toolbar-toggle:hover { background: rgba(255,255,255,0.03); }
        .toolbar-toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: #64748b;
        }
        .toolbar-toggle-arrow {
            transition: transform 0.2s;
            color: #64748b;
        }
        .toolbar-toggle-arrow.collapsed { transform: rotate(-90deg); }
        .notebook-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 8px 16px 12px;
            align-items: center;
        }
        .notebook-toolbar.hidden { display: none; }
        .toolbar-group {
            display: flex;
            gap: 2px;
            background: #0f172a;
            border-radius: 8px;
            padding: 4px;
            border: 1px solid #334155;
        }
        .toolbar-divider {
            width: 1px;
            height: 28px;
            background: #334155;
            margin: 0 4px;
        }
        .toolbar-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: #94a3b8;
            font-size: 0.65rem;
            cursor: pointer;
            min-width: 48px;
            transition: all 0.15s;
        }
        .toolbar-btn:hover { background: #334155; color: #e2e8f0; }
        .toolbar-btn:active { background: #475569; transform: scale(0.95); }
        .toolbar-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .toolbar-btn:disabled:hover { background: transparent; transform: none; }
        .toolbar-btn-icon { font-size: 1.1rem; margin-bottom: 2px; }
        .toolbar-btn-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.03em; }
        .toolbar-btn.primary { background: #0ea5e9; color: white; }
        .toolbar-btn.primary:hover { background: #0284c7; }
        .toolbar-btn.success { background: #22c55e; color: white; }
        .toolbar-btn.success:hover { background: #16a34a; }
        .toolbar-btn.danger:hover { background: #dc2626; color: white; }
        .toolbar-select {
            padding: 6px 10px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            font-size: 0.75rem;
            cursor: pointer;
            min-width: 100px;
        }
        .toolbar-select:focus { outline: none; border-color: #38bdf8; }

        /* Keyboard Shortcuts Panel */
        .key-panel-container {
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            border-bottom: 1px solid #334155;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .key-panel-container.collapsed { max-height: 32px; }
        .key-panel-container.expanded { max-height: 200px; }
        .key-panel-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 16px;
            cursor: pointer;
            user-select: none;
        }
        .key-panel-toggle:hover { background: rgba(255,255,255,0.02); }
        .key-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            padding: 8px 16px 12px;
            justify-content: center;
        }
        .key-panel.hidden { display: none; }
        .key-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .key-group-title {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 4px;
            text-align: center;
        }
        .key-group-keys {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .key-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        .key-cap {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 28px;
            padding: 0 8px;
            background: linear-gradient(180deg, #475569 0%, #334155 100%);
            border: 1px solid #64748b;
            border-bottom-width: 3px;
            border-radius: 5px;
            color: #f1f5f9;
            font-size: 0.7rem;
            font-weight: 600;
            font-family: system-ui, -apple-system, sans-serif;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .key-cap.small { min-width: 24px; font-size: 0.65rem; padding: 0 4px; }
        .key-cap.wide { min-width: 48px; }
        .key-cap.success { background: linear-gradient(180deg, #22c55e 0%, #16a34a 100%); border-color: #4ade80; }
        .key-cap.primary { background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%); border-color: #38bdf8; }
        .key-cap.warning { background: linear-gradient(180deg, #eab308 0%, #ca8a04 100%); border-color: #facc15; color: #0f172a; }
        .key-label {
            font-size: 0.55rem;
            color: #64748b;
            text-align: center;
            max-width: 48px;
        }
        .key-combo {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .key-plus {
            color: #475569;
            font-size: 0.6rem;
        }
        .cell {
            margin-bottom: 16px;
            border: 1px solid #334155;
            border-radius: 8px;
            overflow: hidden;
        }
        .cell.selected { border-color: #38bdf8; }
        .cell-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: #1e293b;
        }
        .cell-controls { display: flex; align-items: center; gap: 8px; }
        .cell-type-label {
            font-size: 0.7rem;
            color: #64748b;
        }
        .cell-content {
            padding: 12px;
            background: #0f172a;
        }
        .cell-content textarea {
            width: 100%;
            min-height: 60px;
            background: transparent;
            border: none;
            color: #e2e8f0;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.875rem;
            resize: none;
            outline: none;
            overflow: hidden;
        }
        .cell-output {
            padding: 12px;
            background: #0c1322;
            border-top: 1px solid #334155;
        }
        .cell-output pre {
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.875rem;
            color: #38bdf8;
            white-space: pre-wrap;
        }
        .cell-output.error pre { color: #f43f5e; }
        .markdown-rendered {
            color: #e2e8f0;
            line-height: 1.6;
        }
        .markdown-rendered h1 { font-size: 1.75rem; font-weight: 700; margin: 0.5em 0; color: #f1f5f9; }
        .markdown-rendered h2 { font-size: 1.5rem; font-weight: 600; margin: 0.5em 0; color: #f1f5f9; }
        .markdown-rendered h3 { font-size: 1.25rem; font-weight: 600; margin: 0.5em 0; color: #f1f5f9; }
        .markdown-rendered p { margin: 0.5em 0; }
        .markdown-rendered code { background: #334155; padding: 2px 6px; border-radius: 4px; font-family: 'Fira Code', monospace; font-size: 0.875rem; }
        .markdown-rendered pre { background: #1e293b; padding: 12px; border-radius: 6px; overflow-x: auto; margin: 0.5em 0; }
        .markdown-rendered pre code { background: none; padding: 0; }
        .markdown-rendered a { color: #38bdf8; text-decoration: underline; }
        .markdown-rendered li { margin-left: 1.5em; }
        .markdown-rendered strong { color: #f1f5f9; }
        .markdown-rendered em { font-style: italic; }
        .markdown-rendered table { border-collapse: collapse; width: 100%; margin: 0.75em 0; }
        .markdown-rendered th, .markdown-rendered td { border: 1px solid #475569; padding: 8px 12px; text-align: left; }
        .markdown-rendered th { background: #1e293b; font-weight: 600; color: #f1f5f9; }
        .markdown-rendered td { background: #0f172a; }
        .markdown-rendered tr:nth-child(even) td { background: #1a2332; }
        .markdown-rendered blockquote { border-left: 3px solid #38bdf8; margin: 0.75em 0; padding: 8px 16px; background: #1e293b; color: #cbd5e1; }
        .markdown-rendered blockquote p { margin: 0.25em 0; }
        .markdown-rendered hr { border: none; border-top: 1px solid #475569; margin: 1.5em 0; }
        .markdown-rendered ul, .markdown-rendered ol { margin: 0.5em 0; padding-left: 1.5em; }
        .markdown-rendered input[type="checkbox"] { margin-right: 6px; }
        .cell-run-btn {
            padding: 4px 10px;
            background: #22c55e;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .cell-run-btn:hover { background: #16a34a; }
        .cell-run-btn:disabled { background: #475569; cursor: not-allowed; }
        .cell-ai-btn {
            padding: 4px 8px;
            background: #7c3aed;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
        }
        .cell-ai-btn:hover { background: #6d28d9; }
        .cell-ai-btn:disabled { background: #475569; cursor: not-allowed; }
        .kernel-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: #94a3b8;
        }
        .kernel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .kernel-dot.ready { background: #22c55e; }
        .kernel-dot.loading { background: #eab308; animation: pulse 1s infinite; }
        .kernel-dot.error { background: #f43f5e; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ========== AI CHAT PANEL ========== */
        .ai-panel-toggle {
            padding: 4px 12px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s;
        }
        .ai-panel-toggle:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .ai-panel-toggle.active { box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.4); }
        .ai-chat-panel {
            background: #1e293b;
            border-top: 2px solid #8b5cf6;
            display: flex;
            flex-direction: column;
            height: 320px;
            flex-shrink: 0;
            transition: height 0.2s ease;
        }
        .ai-chat-panel.collapsed { height: 0; overflow: hidden; border-top: none; }
        .ai-chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 16px;
            background: linear-gradient(90deg, rgba(139,92,246,0.15) 0%, rgba(99,102,241,0.05) 100%);
            border-bottom: 1px solid #334155;
            flex-shrink: 0;
        }
        .ai-chat-header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #c4b5fd;
        }
        .ai-chat-header-actions { display: flex; gap: 6px; align-items: center; }
        .ai-chat-body {
            flex: 1;
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            min-height: 0;
        }
        .ai-chat-input-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .ai-chat-textarea {
            flex: 1;
            width: 100%;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            padding: 10px 12px;
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
            resize: none;
            line-height: 1.5;
        }
        .ai-chat-textarea:focus { outline: none; border-color: #8b5cf6; }
        .ai-chat-textarea::placeholder { color: #64748b; }
        .ai-chat-send-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .ai-chat-send-btn {
            padding: 6px 16px;
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .ai-chat-send-btn:hover { filter: brightness(1.1); }
        .ai-chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }
        .ai-chat-response-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .ai-chat-response-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #64748b;
        }
        .ai-chat-response {
            flex: 1;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 6px;
            padding: 10px 12px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.6;
            color: #cbd5e1;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .ai-chat-response.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #475569;
            font-style: italic;
        }
        .ai-chat-copy-btn {
            padding: 3px 10px;
            background: transparent;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 0.65rem;
            cursor: pointer;
        }
        .ai-chat-copy-btn:hover { background: #334155; color: #e2e8f0; }
        .ai-chat-close-btn {
            padding: 3px 8px;
            background: transparent;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 0.7rem;
            cursor: pointer;
        }
        .ai-chat-close-btn:hover { background: #334155; color: #e2e8f0; }
        .ai-chat-model-select {
            padding: 3px 8px;
            background: #0f172a;
            border: 1px solid #475569;
            border-radius: 4px;
            color: #94a3b8;
            font-size: 0.65rem;
            cursor: pointer;
        }

        /* ========== COURSE PREVIEW (Guest) ========== */
        .course-preview {
            flex: 1;
            overflow-y: auto;
            padding: 48px 32px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .course-preview-back {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: none;
            border: 1px solid #475569;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #38bdf8;
            transition: background 0.2s;
            margin-bottom: 32px;
        }
        .course-preview-back:hover { background: #334155; }
        .course-preview-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }
        .course-preview-icon { font-size: 4rem; }
        .course-preview-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f1f5f9;
        }
        .course-preview-description {
            font-size: 1rem;
            color: #94a3b8;
            line-height: 1.6;
            margin-bottom: 24px;
        }
        .course-preview-meta {
            display: flex;
            gap: 12px;
            margin-bottom: 32px;
        }
        .course-preview-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 0.875rem;
            color: #e2e8f0;
        }
        .course-preview-sections {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 40px;
        }
        .course-preview-sections-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 8px;
        }
        .course-preview-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
        }
        .course-preview-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .course-preview-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
        }
        .course-preview-section-count {
            font-size: 0.8rem;
            color: #64748b;
            background: #0f172a;
            padding: 4px 10px;
            border-radius: 999px;
        }
        .course-preview-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            color: #94a3b8;
            font-size: 0.875rem;
            border-radius: 6px;
        }
        .course-preview-item-icon { font-size: 1rem; }
        .course-preview-item-type {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-left: auto;
        }
        .course-preview-cta {
            text-align: center;
            padding: 32px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
        }
        .course-preview-cta p {
            color: #94a3b8;
            margin-bottom: 16px;
            font-size: 1rem;
        }

        /* Enhanced Guest Preview Styles */
        .course-preview-section-title-new {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .course-preview-section-title-new .section-icon {
            font-size: 1.1rem;
        }
        .course-preview-goals {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .course-preview-goals ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .course-preview-goals li {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            color: #cbd5e1;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .course-preview-goals li::before {
            content: '\2705';
            flex-shrink: 0;
            margin-top: 1px;
        }
        .course-preview-prereqs {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 14px 20px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #cbd5e1;
        }
        .course-preview-prereqs .prereq-label {
            font-weight: 600;
            color: #f1f5f9;
            white-space: nowrap;
        }
        .course-preview-prereqs .prereq-none {
            color: #4ade80;
            font-weight: 500;
        }
        .course-preview-prereqs .prereq-value {
            color: #fbbf24;
        }
        .course-preview-syllabus {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .course-preview-syllabus-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .course-preview-syllabus-pill {
            background: #0f172a;
            border: 1px solid #334155;
            color: #94a3b8;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: border-color 0.2s, color 0.2s;
        }
        .course-preview-syllabus-pill:hover {
            border-color: #38bdf8;
            color: #e2e8f0;
        }
        .course-preview-syllabus-pill { cursor: pointer; }

        /* Topic Description Modal */
        .topic-modal { max-width: 500px; }
        .topic-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 16px;
        }
        .topic-modal h2 { text-align: left; margin-bottom: 0; }
        .topic-modal-close {
            background: none; border: none; color: #94a3b8;
            font-size: 1.5rem; cursor: pointer; padding: 4px 8px;
        }
        .topic-modal-close:hover { color: #f1f5f9; }
        .topic-modal-body { color: #cbd5e1; font-size: 0.95rem; line-height: 1.7; }
        .course-preview-audience-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(56, 189, 248, 0.1);
            border: 1px solid rgba(56, 189, 248, 0.25);
            color: #38bdf8;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const icons = { slides: '', demo: '', lab: '', notes: '' };

        // Auth Modal
        function AuthModal({ onLogin, onSkip }) {
            const [mode, setMode] = useState('login');
            const [username, setUsername] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                const endpoint = mode === 'login' ? '/api/auth/login' : '/api/auth/register';
                const body = mode === 'login' ? { username, password } : { username, email, password, full_name: fullName };
                try {
                    const res = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify(body) });
                    const data = await res.json();
                    if (res.ok) onLogin(data.user);
                    else if (res.status === 403 && data.error && data.error.includes('expired')) {
                        // Account expired  continue as guest
                        onSkip();
                    }
                    else setError(data.error || 'An error occurred');
                } catch (err) { setError('Connection error'); }
                setLoading(false);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h2>Welcome to Course Viewer</h2>
                        <div className="modal-tabs">
                            <button className={`modal-tab ${mode === 'login' ? 'active' : ''}`} onClick={() => setMode('login')}>Login</button>
                            <button className={`modal-tab ${mode === 'register' ? 'active' : ''}`} onClick={() => setMode('register')}>Register</button>
                        </div>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label>Username</label>
                                <input type="text" value={username} onChange={e => setUsername(e.target.value)} required />
                            </div>
                            {mode === 'register' && (
                                <>
                                    <div className="form-group">
                                        <label>Email</label>
                                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} required />
                                    </div>
                                    <div className="form-group">
                                        <label>Full Name</label>
                                        <input type="text" value={fullName} onChange={e => setFullName(e.target.value)} />
                                    </div>
                                </>
                            )}
                            <div className="form-group">
                                <label>Password</label>
                                <div className="password-wrapper">
                                    <input type={showPassword ? "text" : "password"} value={password} onChange={e => setPassword(e.target.value)} required />
                                    <button type="button" className="password-toggle" onClick={() => setShowPassword(!showPassword)} tabIndex={-1} title={showPassword ? "Hide password" : "Show password"}
                                        dangerouslySetInnerHTML={{__html: showPassword
                                            ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
                                            : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'
                                        }} />
                                </div>
                            </div>
                            <button type="submit" className="btn btn-primary" style={{width: '100%'}} disabled={loading}>
                                {loading ? 'Please wait...' : (mode === 'login' ? 'Login' : 'Register')}
                            </button>
                            {error && <div className="form-error">{error}</div>}
                        </form>
                        <div className="modal-footer">
                            <button onClick={onSkip}>Continue as Guest</button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminModal({ courses, onClose }) {
            const [courseId, setCourseId] = useState('');
            const [expiresAt, setExpiresAt] = useState('');
            const [input, setInput] = useState('');
            const [preview, setPreview] = useState(null);
            const [results, setResults] = useState(null);
            const [adminLoading, setAdminLoading] = useState(false);
            const [error, setError] = useState('');
            const [copied, setCopied] = useState(false);

            // Roster state
            const [roster, setRoster] = useState([]);
            const [rosterLoading, setRosterLoading] = useState(false);
            const [addStudentId, setAddStudentId] = useState('');
            const [addStudentError, setAddStudentError] = useState('');

            // Instructor assignment state
            const [courseInstructors, setCourseInstructors] = useState([]);
            const [allInstructors, setAllInstructors] = useState([]);
            const [assignInstructorId, setAssignInstructorId] = useState('');

            // Fetch all instructor accounts on mount
            useEffect(() => {
                fetch('/api/admin/users', { credentials: 'include' })
                    .then(res => res.json())
                    .then(users => setAllInstructors(users.filter(u => u.role === 'instructor' || u.role === 'admin')))
                    .catch(() => {});
            }, []);

            // Fetch roster + course instructors when course changes
            const fetchRoster = (cid) => {
                if (!cid) { setRoster([]); return; }
                setRosterLoading(true);
                fetch(`/api/admin/course/${cid}/enrollments`, { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => { setRoster(data); setRosterLoading(false); })
                    .catch(() => { setRoster([]); setRosterLoading(false); });
            };

            const fetchCourseInstructors = (cid) => {
                if (!cid) { setCourseInstructors([]); return; }
                fetch(`/api/course/${cid}/instructors`)
                    .then(res => res.json())
                    .then(data => setCourseInstructors(data))
                    .catch(() => setCourseInstructors([]));
            };

            useEffect(() => {
                let cancelled = false;
                if (courseId) {
                    setRosterLoading(true);
                    setAddStudentError('');
                    Promise.all([
                        fetch(`/api/admin/course/${courseId}/enrollments`, { credentials: 'include' }).then(r => r.json()),
                        fetch(`/api/course/${courseId}/instructors`).then(r => r.json())
                    ]).then(([rosterData, instrData]) => {
                        if (!cancelled) {
                            setRoster(rosterData);
                            setCourseInstructors(instrData);
                            setRosterLoading(false);
                        }
                    }).catch(() => {
                        if (!cancelled) { setRoster([]); setCourseInstructors([]); setRosterLoading(false); }
                    });
                } else {
                    setRoster([]);
                    setCourseInstructors([]);
                }
                return () => { cancelled = true; };
            }, [courseId]);

            const parseInput = (text) => {
                const lines = text.trim().split('\n').filter(l => l.trim());
                return lines.map(line => {
                    line = line.trim();
                    const angleMatch = line.match(/^(.+?)\s*<([^>]+)>/);
                    if (angleMatch) return { name: angleMatch[1].trim(), email: angleMatch[2].trim() };
                    const tabParts = line.split('\t');
                    if (tabParts.length >= 2) return { name: tabParts[0].trim(), email: tabParts[tabParts.length - 1].trim() };
                    const commaParts = line.split(',');
                    if (commaParts.length >= 2) {
                        const email = commaParts[commaParts.length - 1].trim();
                        const name = commaParts.slice(0, -1).join(',').trim();
                        return { name, email };
                    }
                    return null;
                }).filter(Boolean);
            };

            const generateUsername = (name) => {
                const parts = name.trim().split(/\s+/);
                if (parts.length < 2) return null;
                const firstInitial = parts[0][0].toLowerCase();
                const lastName = parts[parts.length - 1].toLowerCase().replace(/[^a-z0-9\-]/g, '');
                return firstInitial + lastName;
            };

            const handlePreview = () => {
                const students = parseInput(input);
                if (!students.length) { setError('Could not parse any students. Use format: Name, email'); return; }
                setError('');
                const seen = new Set();
                const previewed = students.map(s => {
                    let username = generateUsername(s.name);
                    if (!username) return { ...s, username: '(invalid name)' };
                    let base = username;
                    let counter = 1;
                    while (seen.has(username)) { username = base + counter; counter++; }
                    seen.add(username);
                    return { ...s, username };
                });
                setPreview(previewed);
                setResults(null);
            };

            const handleCreate = async () => {
                if (!preview || !preview.length) return;
                setAdminLoading(true);
                setError('');
                try {
                    const res = await fetch('/api/admin/bulk-register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            students: preview.filter(s => s.username !== '(invalid name)').map(s => ({ name: s.name, email: s.email })),
                            course_id: courseId,
                            expires_at: expiresAt || ''
                        })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setResults(data);
                        setPreview(null);
                        fetchRoster(courseId);
                    } else {
                        setError(data.error || 'Failed to create accounts');
                    }
                } catch (err) { setError('Connection error'); }
                setAdminLoading(false);
            };

            const handleCopyAll = () => {
                if (!results || !results.created) return;
                const text = results.created.map(r =>
                    `${r.full_name}\t${r.username}\t${r.password}\t${r.email}`
                ).join('\n');
                navigator.clipboard.writeText('Name\tUsername\tPassword\tEmail\n' + text);
                setCopied(true);
                setTimeout(() => setCopied(false), 2000);
            };

            const handleDeleteEnrollment = async (enrollmentId, username) => {
                if (!confirm(`Remove ${username} from this course? (Their account will not be deleted.)`)) return;
                try {
                    const res = await fetch(`/api/admin/enrollment/${enrollmentId}`, {
                        method: 'DELETE', credentials: 'include'
                    });
                    if (res.ok) fetchRoster(courseId);
                } catch (err) {}
            };

            const handleEnrollExisting = async (e) => {
                e.preventDefault();
                if (!addStudentId.trim() || !courseId) return;
                setAddStudentError('');
                try {
                    const res = await fetch('/api/admin/enroll-existing', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ course_id: courseId, identifier: addStudentId.trim() })
                    });
                    const data = await res.json();
                    if (res.ok) {
                        setAddStudentId('');
                        fetchRoster(courseId);
                    } else {
                        setAddStudentError(data.error || 'Failed to enroll student');
                    }
                } catch (err) { setAddStudentError('Connection error'); }
            };

            const handleAssignInstructor = async () => {
                if (!assignInstructorId || !courseId) return;
                try {
                    const res = await fetch('/api/admin/course-instructors', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ course_id: courseId, user_id: parseInt(assignInstructorId) })
                    });
                    if (res.ok) {
                        setAssignInstructorId('');
                        fetchCourseInstructors(courseId);
                    }
                } catch (err) {}
            };

            const handleRemoveInstructor = async (assignmentId) => {
                try {
                    const res = await fetch(`/api/admin/course-instructor/${assignmentId}`, {
                        method: 'DELETE', credentials: 'include'
                    });
                    if (res.ok) fetchCourseInstructors(courseId);
                } catch (err) {}
            };

            const assignedIds = new Set(courseInstructors.map(ci => ci.user_id));
            const availableInstructors = allInstructors.filter(i => !assignedIds.has(i.id));

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal admin-modal" onClick={e => e.stopPropagation()}>
                        <div className="topic-modal-header">
                            <h2>Course Management</h2>
                            <button className="topic-modal-close" onClick={onClose}>&times;</button>
                        </div>

                        <div className="form-group">
                            <label>Course</label>
                            <select value={courseId} onChange={e => { setCourseId(e.target.value); setPreview(null); setResults(null); setError(''); }}>
                                <option value="">-- Select course --</option>
                                {courses.map(c => <option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}
                            </select>
                        </div>

                        {courseId && (
                            <>
                                {/* Section 1: Assigned Instructors */}
                                <div className="admin-section">
                                    <div className="admin-section-title">Assigned Instructors</div>
                                    {courseInstructors.length > 0 ? (
                                        <div>
                                            {courseInstructors.map(ci => (
                                                <span key={ci.assignment_id} className="instructor-chip">
                                                    {ci.full_name || ci.username}
                                                    <button onClick={() => handleRemoveInstructor(ci.assignment_id)} title="Remove">&times;</button>
                                                </span>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="admin-empty">No instructors assigned</div>
                                    )}
                                    {availableInstructors.length > 0 && (
                                        <div className="admin-inline-form">
                                            <select value={assignInstructorId} onChange={e => setAssignInstructorId(e.target.value)}
                                                style={{flex:1,padding:'7px 10px',background:'#0f172a',border:'1px solid #475569',borderRadius:'6px',color:'#e2e8f0',fontSize:'0.8rem'}}>
                                                <option value="">-- Select instructor --</option>
                                                {availableInstructors.map(i => (
                                                    <option key={i.id} value={i.id}>{i.full_name || i.username} ({i.username})</option>
                                                ))}
                                            </select>
                                            <button className="btn btn-primary btn-sm" onClick={handleAssignInstructor} disabled={!assignInstructorId}>Assign</button>
                                        </div>
                                    )}
                                </div>

                                {/* Section 2: Enrolled Students (Roster) */}
                                <div className="admin-section">
                                    <div className="admin-section-title">Enrolled Students ({roster.length})</div>
                                    {rosterLoading ? (
                                        <div className="admin-empty">Loading...</div>
                                    ) : roster.length > 0 ? (
                                        <div className="admin-table-wrapper">
                                            <table className="admin-table">
                                                <thead><tr><th>Username</th><th>Password</th><th>Full Name</th><th>Email</th><th>Enrolled</th><th></th></tr></thead>
                                                <tbody>
                                                    {roster.map(r => (
                                                        <tr key={r.enrollment_id}>
                                                            <td>{r.username}</td>
                                                            <td style={{fontFamily:'monospace',fontSize:'0.8rem',color:'#94a3b8'}}>{r.plain_password || ''}</td>
                                                            <td style={{fontFamily:'inherit'}}>{r.full_name}</td>
                                                            <td>{r.email}</td>
                                                            <td>{r.enrolled_at ? new Date(r.enrolled_at).toLocaleDateString() : ''}</td>
                                                            <td><button className="admin-delete-btn" onClick={() => handleDeleteEnrollment(r.enrollment_id, r.username)} title="Remove enrollment">&times;</button></td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="admin-empty">No students enrolled</div>
                                    )}
                                    <form className="admin-inline-form" onSubmit={handleEnrollExisting}>
                                        <input type="text" value={addStudentId} onChange={e => setAddStudentId(e.target.value)}
                                            placeholder="Username or email" />
                                        <button type="submit" className="btn btn-primary btn-sm" disabled={!addStudentId.trim()}>Enroll</button>
                                    </form>
                                    {addStudentError && <div className="form-error" style={{marginTop:'6px',fontSize:'0.8rem'}}>{addStudentError}</div>}
                                </div>

                                {/* Section 3: Bulk Register (existing flow) */}
                                <div className="admin-section">
                                    <div className="admin-section-title">Bulk Register New Students</div>

                                    <div className="form-group" style={{marginBottom:'8px'}}>
                                        <label>Expires (optional)</label>
                                        <input type="datetime-local" value={expiresAt} onChange={e => setExpiresAt(e.target.value)} />
                                    </div>

                                    <div className="form-group">
                                        <label>Students (one per line)</label>
                                        <textarea
                                            value={input}
                                            onChange={e => setInput(e.target.value)}
                                            placeholder={"Joe Smith, joe@example.com\nJane Doe <jane@example.com>\nBob Jones\tbob@example.com"}
                                            rows={5}
                                        />
                                        <div className="hint">Formats: Name, email | Name &lt;email&gt; | Name[tab]email</div>
                                    </div>

                                    <div className="admin-actions">
                                        <button className="btn btn-ghost" onClick={handlePreview} disabled={!input.trim()}>Preview</button>
                                        {preview && preview.length > 0 && (
                                            <button className="btn btn-primary" onClick={handleCreate} disabled={adminLoading}>
                                                {adminLoading ? 'Creating...' : `Create ${preview.filter(s => s.username !== '(invalid name)').length} Accounts`}
                                            </button>
                                        )}
                                    </div>

                                    {error && <div className="form-error">{error}</div>}

                                    {preview && (
                                        <div>
                                            <h3 style={{fontSize:'0.875rem',color:'#94a3b8',marginBottom:'8px'}}>Preview</h3>
                                            <table className="admin-table">
                                                <thead><tr><th>Full Name</th><th>Email</th><th>Username</th></tr></thead>
                                                <tbody>
                                                    {preview.map((s, i) => (
                                                        <tr key={i}>
                                                            <td style={{fontFamily:'inherit'}}>{s.name}</td>
                                                            <td>{s.email}</td>
                                                            <td>{s.username}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}

                                    {results && (
                                        <div>
                                            {results.total_created > 0 && (
                                                <div className="admin-success">{results.total_created} account(s) created successfully</div>
                                            )}
                                            {results.errors && results.errors.length > 0 && (
                                                <div className="admin-errors">
                                                    <ul>{results.errors.map((e, i) => <li key={i}>{e}</li>)}</ul>
                                                </div>
                                            )}
                                            {results.created && results.created.length > 0 && (
                                                <div>
                                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'8px'}}>
                                                        <h3 style={{fontSize:'0.875rem',color:'#94a3b8'}}>Credentials</h3>
                                                        <button className="copy-all-btn" onClick={handleCopyAll}>
                                                            {copied ? 'Copied!' : 'Copy All'}
                                                        </button>
                                                    </div>
                                                    <table className="admin-table">
                                                        <thead><tr><th>Username</th><th>Password</th><th>Full Name</th><th>Email</th></tr></thead>
                                                        <tbody>
                                                            {results.created.map((r, i) => (
                                                                <tr key={i}>
                                                                    <td>{r.username}</td>
                                                                    <td>{r.password}</td>
                                                                    <td style={{fontFamily:'inherit'}}>{r.full_name}</td>
                                                                    <td>{r.email}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Markdown to HTML converter with table, blockquote, and HR support
        function renderMarkdownToHtml(md, cellIdx, fillValues) {
            // First extract code blocks to protect them from other processing
            const codeBlocks = [];
            md = md.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                codeBlocks.push('<pre><code>' + code.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</code></pre>');
                return '\x00CODEBLOCK' + (codeBlocks.length - 1) + '\x00';
            });

            const lines = md.split('\n');
            const result = [];
            let i = 0;

            while (i < lines.length) {
                const line = lines[i];

                // Table: detect consecutive lines starting with |
                if (line.trim().startsWith('|') && line.trim().endsWith('|')) {
                    const tableLines = [];
                    while (i < lines.length && lines[i].trim().startsWith('|') && lines[i].trim().endsWith('|')) {
                        tableLines.push(lines[i].trim());
                        i++;
                    }
                    if (tableLines.length >= 2) {
                        let tableHtml = '<table>';
                        // Check if second line is separator (|---|---|)
                        const isSep = /^\|[\s\-:]+\|/.test(tableLines[1]);
                        const startRow = isSep ? 2 : 0;
                        if (isSep) {
                            // Header row
                            const cells = tableLines[0].split('|').filter(c => c.trim() !== '');
                            tableHtml += '<thead><tr>' + cells.map(c => '<th>' + inlineMarkdown(c.trim()) + '</th>').join('') + '</tr></thead>';
                        }
                        tableHtml += '<tbody>';
                        for (let r = startRow; r < tableLines.length; r++) {
                            const cells = tableLines[r].split('|').filter(c => c.trim() !== '');
                            tableHtml += '<tr>' + cells.map(c => '<td>' + inlineMarkdown(c.trim()) + '</td>').join('') + '</tr>';
                        }
                        tableHtml += '</tbody></table>';
                        result.push(tableHtml);
                    }
                    continue;
                }

                // Blockquote: lines starting with >
                if (line.trim().startsWith('>')) {
                    const bqLines = [];
                    while (i < lines.length && (lines[i].trim().startsWith('>') || (lines[i].trim() !== '' && bqLines.length > 0 && !lines[i].trim().startsWith('#') && !lines[i].trim().startsWith('|')))) {
                        if (!lines[i].trim().startsWith('>') && lines[i].trim() === '') break;
                        bqLines.push(lines[i].trim().replace(/^>\s?/, ''));
                        i++;
                    }
                    result.push('<blockquote>' + bqLines.map(l => inlineMarkdown(l)).join('<br>') + '</blockquote>');
                    continue;
                }

                // Horizontal rule
                if (/^(\-{3,}|\*{3,}|_{3,})\s*$/.test(line.trim())) {
                    result.push('<hr>');
                    i++;
                    continue;
                }

                // Headings
                if (line.trim().startsWith('### ')) {
                    result.push('<h3>' + inlineMarkdown(line.trim().slice(4)) + '</h3>');
                    i++;
                    continue;
                }
                if (line.trim().startsWith('## ')) {
                    result.push('<h2>' + inlineMarkdown(line.trim().slice(3)) + '</h2>');
                    i++;
                    continue;
                }
                if (line.trim().startsWith('# ')) {
                    result.push('<h1>' + inlineMarkdown(line.trim().slice(2)) + '</h1>');
                    i++;
                    continue;
                }

                // Unordered list
                if (/^\s*[\-\*]\s+/.test(line)) {
                    const listItems = [];
                    while (i < lines.length && /^\s*[\-\*]\s+/.test(lines[i])) {
                        const content = lines[i].replace(/^\s*[\-\*]\s+/, '');
                        // Checkbox support
                        if (content.startsWith('[ ] ')) {
                            listItems.push('<li><input type="checkbox" disabled>' + inlineMarkdown(content.slice(4)) + '</li>');
                        } else if (content.startsWith('[x] ') || content.startsWith('[X] ')) {
                            listItems.push('<li><input type="checkbox" checked disabled>' + inlineMarkdown(content.slice(4)) + '</li>');
                        } else {
                            listItems.push('<li>' + inlineMarkdown(content) + '</li>');
                        }
                        i++;
                    }
                    result.push('<ul>' + listItems.join('') + '</ul>');
                    continue;
                }

                // Ordered list
                if (/^\s*\d+\.\s+/.test(line)) {
                    const listItems = [];
                    while (i < lines.length && /^\s*\d+\.\s+/.test(lines[i])) {
                        listItems.push('<li>' + inlineMarkdown(lines[i].replace(/^\s*\d+\.\s+/, '')) + '</li>');
                        i++;
                    }
                    result.push('<ol>' + listItems.join('') + '</ol>');
                    continue;
                }

                // Code block placeholder
                if (line.trim().startsWith('\x00CODEBLOCK')) {
                    const idx = parseInt(line.trim().match(/\x00CODEBLOCK(\d+)\x00/)?.[1]);
                    if (!isNaN(idx)) result.push(codeBlocks[idx]);
                    i++;
                    continue;
                }

                // Empty line
                if (line.trim() === '') {
                    i++;
                    continue;
                }

                // Paragraph  collect consecutive non-empty lines
                const paraLines = [];
                while (i < lines.length && lines[i].trim() !== '' && !lines[i].trim().startsWith('#') && !lines[i].trim().startsWith('>') && !lines[i].trim().startsWith('|') && !/^(\-{3,}|\*{3,}|_{3,})\s*$/.test(lines[i].trim()) && !/^\s*[\-\*]\s+/.test(lines[i]) && !/^\s*\d+\.\s+/.test(lines[i]) && !lines[i].trim().startsWith('\x00CODEBLOCK')) {
                    paraLines.push(lines[i]);
                    i++;
                }
                if (paraLines.length > 0) {
                    result.push('<p>' + inlineMarkdown(paraLines.join(' ')) + '</p>');
                }
            }

            // Final pass: convert ___ runs to <input> elements for fill-in-the-blank
            let html = result.join('\n');
            if (typeof cellIdx === 'number') {
                let blankCounter = 0;
                html = html.replace(/_{3,}/g, () => {
                    const key = cellIdx + '-' + blankCounter;
                    const val = fillValues && fillValues[key] != null ? fillValues[key].replace(/"/g, '&quot;') : '';
                    const wide = blankCounter === 0 || val.length > 20;
                    blankCounter++;
                    return '<input type="text" class="fill-blank' + (wide ? ' fill-blank-wide' : '') + '" data-fill-key="' + key + '" value="' + val + '" placeholder="Type here...">';
                });
            }
            // Replace <!-- submit-exercise --> marker with a submit button (strip wrapping <p> if present)
            html = html.replace(/<p>\s*<!--\s*submit-exercise\s*-->\s*<\/p>/g,
                '<div class="exercise-submit-wrapper"><button class="exercise-submit-btn" data-cell-idx="' + cellIdx + '">\u{1F4DD} Submit for AI Review</button></div>');
            html = html.replace(/<!--\s*submit-exercise\s*-->/g,
                '<div class="exercise-submit-wrapper"><button class="exercise-submit-btn" data-cell-idx="' + cellIdx + '">\u{1F4DD} Submit for AI Review</button></div>');
            return html;
        }

        // Inline markdown: bold, italic, code, links, strikethrough
        function inlineMarkdown(text) {
            return text
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/~~(.+?)~~/g, '<del>$1</del>')
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
        }

        // Notebook Viewer - Full Featured
        function NotebookViewer({ labId, onBack }) {
            const [notebook, setNotebook] = useState(null);
            const [pyodide, setPyodide] = useState(null);
            const [status, setStatus] = useState('loading');
            const [outputs, setOutputs] = useState({});
            const [running, setRunning] = useState(null);
            const [selected, setSelected] = useState(0);
            const [clipboard, setClipboard] = useState(null);
            const [clipboardAction, setClipboardAction] = useState(null); // 'copy' or 'cut'
            const [editMode, setEditMode] = useState(false);
            const [showSaveAs, setShowSaveAs] = useState(false);
            const [saveAsName, setSaveAsName] = useState('');
            const [kernel, setKernel] = useState('pyodide');
            const [dirty, setDirty] = useState(false);
            const [renderedCells, setRenderedCells] = useState({}); // Track which markdown cells are rendered
            const [commandMode, setCommandMode] = useState(true); // true = command mode, false = edit mode
            const [showToolbar, setShowToolbar] = useState(true);
            const [showShortcuts, setShowShortcuts] = useState(false);
            const [showKeyPanel, setShowKeyPanel] = useState(true);
            const [showAIPanel, setShowAIPanel] = useState(false);
            const [aiPrompt, setAiPrompt] = useState('');
            const [aiResponse, setAiResponse] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [aiModel, setAiModel] = useState('gpt-4o');
            const containerRef = useRef(null);
            const fillBlanksRef = useRef({});

            // Flush fill-in-the-blank values back into cell source for a given cell
            const flushFillBlanks = (idx) => {
                const src = getSource(notebook.cells[idx]);
                let blankCounter = 0;
                const patched = src.replace(/_{3,}/g, () => {
                    const key = idx + '-' + blankCounter;
                    blankCounter++;
                    const val = fillBlanksRef.current[key];
                    return val ? val : '___';
                });
                if (patched !== src) {
                    setSource(idx, patched);
                }
            };

            // Flush all fill-in-the-blank values across all cells
            const flushAllFillBlanks = () => {
                if (!notebook) return;
                const cells = [...notebook.cells];
                let changed = false;
                cells.forEach((cell, idx) => {
                    if (cell.cell_type !== 'markdown') return;
                    const src = getSource(cell);
                    let blankCounter = 0;
                    const patched = src.replace(/_{3,}/g, () => {
                        const key = idx + '-' + blankCounter;
                        blankCounter++;
                        const val = fillBlanksRef.current[key];
                        return val ? val : '___';
                    });
                    if (patched !== src) {
                        cells[idx] = { ...cells[idx], source: patched.split('\n').map((l,i,a) => i < a.length-1 ? l+'\n' : l) };
                        changed = true;
                    }
                });
                if (changed) {
                    setNotebook({ ...notebook, cells });
                    setDirty(true);
                }
            };

            const availableKernels = [
                { id: 'pyodide', name: 'Python (Pyodide - Browser)', icon: '' },
                { id: 'server', name: 'Python (Server)', icon: '' }
            ];

            // Toggle ai-panel-open class on .main parent when AI panel is shown
            useEffect(() => {
                const mainEl = containerRef.current?.closest('.main');
                if (mainEl) {
                    if (showAIPanel) mainEl.classList.add('ai-panel-open');
                    else mainEl.classList.remove('ai-panel-open');
                }
                return () => {
                    const mainEl = containerRef.current?.closest('.main');
                    if (mainEl) mainEl.classList.remove('ai-panel-open');
                };
            }, [showAIPanel]);

            useEffect(() => {
                fetch(`/api/lab/${labId}/notebook`, { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => {
                        setNotebook(data);
                        // Auto-render ALL markdown cells on load
                        if (data && data.cells) {
                            const rendered = {};
                            data.cells.forEach((cell, idx) => {
                                if (cell.cell_type === 'markdown') {
                                    rendered[idx] = true;
                                }
                            });
                            setRenderedCells(rendered);
                        }
                        setSaveAsName(labId + '-copy');
                        if (kernel === 'pyodide') {
                            loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" })
                                .then(async py => {
                                    await py.loadPackage(['numpy', 'pandas', 'matplotlib', 'scikit-learn']);
                                    setPyodide(py);
                                    setStatus('ready');
                                })
                                .catch(() => setStatus('error'));
                        } else {
                            fetch('/api/kernel/start', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({ lab_id: labId })
                            }).then(() => setStatus('ready')).catch(() => setStatus('error'));
                        }
                    });
            }, [labId]);

            // Execute cell (code or markdown)
            const executeCell = (idx) => {
                const cell = notebook.cells[idx];
                if (cell.cell_type === 'code') {
                    runCell(idx);
                } else if (cell.cell_type === 'markdown') {
                    // Toggle markdown render
                    setRenderedCells(prev => ({ ...prev, [idx]: true }));
                    setCommandMode(true);
                    document.activeElement?.blur();
                }
            };

            // Enter edit mode for a cell
            const enterEditMode = (idx) => {
                setCommandMode(false);
                // For markdown cells, un-render them first
                if (notebook.cells[idx]?.cell_type === 'markdown') {
                    setRenderedCells(prev => ({ ...prev, [idx]: false }));
                }
                setTimeout(() => {
                    containerRef.current?.querySelector('.cell.selected textarea')?.focus();
                }, 0);
            };

            // Keyboard shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (!notebook) return;
                    const isEditing = document.activeElement?.tagName === 'TEXTAREA' || document.activeElement?.tagName === 'INPUT';

                    // Global shortcuts (work in both modes)
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        if (e.shiftKey) setShowSaveAs(true);
                        else saveNotebook();
                        return;
                    }

                    // Ctrl+Enter or Shift+Enter - run/render cell (works in both modes)
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        executeCell(selected);
                        return;
                    }

                    if (e.key === 'Enter' && e.shiftKey) {
                        e.preventDefault();
                        executeCell(selected);
                        // Move to next cell after execution
                        if (selected < notebook.cells.length - 1) {
                            setSelected(selected + 1);
                        }
                        return;
                    }

                    // Edit mode shortcuts
                    if (isEditing) {
                        if (e.key === 'Escape') {
                            e.preventDefault();
                            setCommandMode(true);
                            // Render markdown on escape
                            if (notebook.cells[selected]?.cell_type === 'markdown') {
                                setRenderedCells(prev => ({ ...prev, [selected]: true }));
                            }
                            document.activeElement?.blur();
                        }
                        // Arrow up on first line of textarea  move to previous cell
                        if (e.key === 'ArrowUp') {
                            const ta = document.activeElement;
                            const textBefore = ta.value.substring(0, ta.selectionStart);
                            const onFirstLine = !textBefore.includes('\n');
                            if (onFirstLine && selected > 0) {
                                e.preventDefault();
                                setSelected(selected - 1);
                                setCommandMode(true);
                                ta.blur();
                                setTimeout(() => {
                                    const cell = containerRef.current?.querySelectorAll('.cell')[selected - 1];
                                    cell?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                }, 0);
                            }
                        }
                        // Arrow down on last line of textarea  move to next cell
                        if (e.key === 'ArrowDown') {
                            const ta = document.activeElement;
                            const textAfter = ta.value.substring(ta.selectionEnd);
                            const onLastLine = !textAfter.includes('\n');
                            if (onLastLine && selected < notebook.cells.length - 1) {
                                e.preventDefault();
                                setSelected(selected + 1);
                                setCommandMode(true);
                                ta.blur();
                                setTimeout(() => {
                                    const cell = containerRef.current?.querySelectorAll('.cell')[selected + 1];
                                    cell?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                }, 0);
                            }
                        }
                        return;
                    }

                    // Command mode shortcuts (when not editing)
                    switch (e.key) {
                        case 'ArrowUp': case 'k':
                            e.preventDefault();
                            if (selected > 0) {
                                setSelected(selected - 1);
                                setTimeout(() => {
                                    containerRef.current?.querySelectorAll('.cell')[selected - 1]
                                        ?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                }, 0);
                            }
                            break;
                        case 'ArrowDown': case 'j':
                            e.preventDefault();
                            if (selected < notebook.cells.length - 1) {
                                setSelected(selected + 1);
                                setTimeout(() => {
                                    containerRef.current?.querySelectorAll('.cell')[selected + 1]
                                        ?.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                                }, 0);
                            }
                            break;
                        case 'Enter':
                            e.preventDefault();
                            enterEditMode(selected);
                            break;
                        case 'a':
                            e.preventDefault();
                            insertCell(selected, 'code');
                            break;
                        case 'b':
                            e.preventDefault();
                            insertCell(selected + 1, 'code');
                            setSelected(selected + 1);
                            break;
                        case 'c':
                            e.preventDefault();
                            copyCell();
                            break;
                        case 'x':
                            e.preventDefault();
                            cutCell();
                            break;
                        case 'v':
                            e.preventDefault();
                            pasteCell();
                            break;
                        case 'd':
                            if (e.repeat || window._lastKey === 'd') {
                                e.preventDefault();
                                deleteCell(selected);
                                window._lastKey = null;
                            } else {
                                window._lastKey = 'd';
                                setTimeout(() => { window._lastKey = null; }, 500);
                            }
                            break;
                        case 'm':
                            e.preventDefault();
                            changeCellType(selected, 'markdown');
                            break;
                        case 'y':
                            e.preventDefault();
                            changeCellType(selected, 'code');
                            break;
                        case 'r':
                            if (e.shiftKey) {
                                e.preventDefault();
                                restartKernel();
                            }
                            break;
                        case '?':
                            e.preventDefault();
                            setShowShortcuts(true);
                            break;
                        case 'h':
                            e.preventDefault();
                            setShowToolbar(!showToolbar);
                            break;
                        case 'k':
                            if (e.shiftKey) {
                                e.preventDefault();
                                setShowKeyPanel(!showKeyPanel);
                            }
                            break;
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [notebook, selected, clipboard, status, running, commandMode, renderedCells, showToolbar, showKeyPanel]);

            // Auto-resize all textareas to fit content
            const autoResizeTextareas = useCallback(() => {
                if (!containerRef.current) return;
                containerRef.current.querySelectorAll('textarea').forEach(ta => {
                    ta.style.height = 'auto';
                    ta.style.height = ta.scrollHeight + 'px';
                });
            }, []);

            useEffect(() => {
                autoResizeTextareas();
            });

            // Forward wheel events from textareas to the main scroll container
            useEffect(() => {
                if (!containerRef.current) return;
                const mainEl = containerRef.current.closest('.main');
                if (!mainEl) return;
                const handleWheel = (e) => {
                    if (e.target.tagName === 'TEXTAREA') {
                        e.preventDefault();
                        mainEl.scrollTop += e.deltaY;
                    }
                };
                mainEl.addEventListener('wheel', handleWheel, { passive: false });
                return () => mainEl.removeEventListener('wheel', handleWheel);
            }, [notebook]);

            const getSource = (cell) => Array.isArray(cell.source) ? cell.source.join('') : cell.source;

            const setSource = (idx, val) => {
                const cells = [...notebook.cells];
                cells[idx] = { ...cells[idx], source: val.split('\n').map((l,i,a) => i < a.length-1 ? l+'\n' : l) };
                setNotebook({ ...notebook, cells });
                setDirty(true);
            };

            const runCell = async (idx) => {
                if (status !== 'ready' || running !== null) return;
                const cell = notebook.cells[idx];
                if (cell.cell_type !== 'code') return;
                const code = getSource(cell);
                setRunning(idx);

                try {
                    if (kernel === 'pyodide' && pyodide) {
                        pyodide.runPython('import sys; from io import StringIO; sys.stdout = StringIO()');
                        const result = await pyodide.runPythonAsync(code);
                        const stdout = pyodide.runPython('sys.stdout.getvalue()');
                        setOutputs(prev => ({ ...prev, [idx]: { output: stdout || (result !== undefined ? String(result) : ''), error: false } }));
                    } else {
                        const res = await fetch('/api/kernel/execute', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ lab_id: labId, code })
                        });
                        const data = await res.json();
                        const output = data.outputs?.map(o => o.text || o.data?.['text/plain'] || '').join('\n') || '';
                        setOutputs(prev => ({ ...prev, [idx]: { output, error: data.status === 'error' } }));
                    }
                } catch (err) {
                    setOutputs(prev => ({ ...prev, [idx]: { output: err.message, error: true } }));
                }
                setRunning(null);
            };

            const runAllCells = async () => {
                for (let i = 0; i < notebook.cells.length; i++) {
                    if (notebook.cells[i].cell_type === 'code') await runCell(i);
                }
            };

            const insertCell = (idx, type = 'code') => {
                const newCell = {
                    cell_type: type,
                    source: '',
                    metadata: {},
                    ...(type === 'code' ? { outputs: [], execution_count: null } : {})
                };
                const cells = [...notebook.cells];
                cells.splice(idx, 0, newCell);
                setNotebook({ ...notebook, cells });
                setDirty(true);
            };

            const deleteCell = (idx) => {
                if (notebook.cells.length <= 1) return;
                const cells = [...notebook.cells];
                cells.splice(idx, 1);
                const newOutputs = { ...outputs };
                delete newOutputs[idx];
                // Reindex outputs
                const reindexed = {};
                Object.keys(newOutputs).forEach(k => {
                    const ki = parseInt(k);
                    reindexed[ki > idx ? ki - 1 : ki] = newOutputs[k];
                });
                setOutputs(reindexed);
                setNotebook({ ...notebook, cells });
                if (selected >= cells.length) setSelected(cells.length - 1);
                setDirty(true);
            };

            const copyCell = () => {
                setClipboard(JSON.parse(JSON.stringify(notebook.cells[selected])));
                setClipboardAction('copy');
            };

            const cutCell = () => {
                setClipboard(JSON.parse(JSON.stringify(notebook.cells[selected])));
                setClipboardAction('cut');
                deleteCell(selected);
            };

            const pasteCell = () => {
                if (!clipboard) return;
                const cells = [...notebook.cells];
                cells.splice(selected + 1, 0, JSON.parse(JSON.stringify(clipboard)));
                setNotebook({ ...notebook, cells });
                setSelected(selected + 1);
                setDirty(true);
            };

            const changeCellType = (idx, type) => {
                const cells = [...notebook.cells];
                cells[idx] = {
                    ...cells[idx],
                    cell_type: type,
                    ...(type === 'code' ? { outputs: [], execution_count: null } : {})
                };
                setNotebook({ ...notebook, cells });
                setDirty(true);
            };

            const moveCellUp = () => {
                if (selected === 0) return;
                const cells = [...notebook.cells];
                [cells[selected - 1], cells[selected]] = [cells[selected], cells[selected - 1]];
                const newOutputs = { ...outputs };
                const tmp = newOutputs[selected];
                newOutputs[selected] = newOutputs[selected - 1];
                newOutputs[selected - 1] = tmp;
                setOutputs(newOutputs);
                setNotebook({ ...notebook, cells });
                setSelected(selected - 1);
                setDirty(true);
            };

            const moveCellDown = () => {
                if (selected >= notebook.cells.length - 1) return;
                const cells = [...notebook.cells];
                [cells[selected], cells[selected + 1]] = [cells[selected + 1], cells[selected]];
                const newOutputs = { ...outputs };
                const tmp = newOutputs[selected];
                newOutputs[selected] = newOutputs[selected + 1];
                newOutputs[selected + 1] = tmp;
                setOutputs(newOutputs);
                setNotebook({ ...notebook, cells });
                setSelected(selected + 1);
                setDirty(true);
            };

            const saveNotebook = async () => {
                // Flush fill-in-the-blank values into cell sources before saving
                let nb = notebook;
                if (Object.keys(fillBlanksRef.current).length > 0) {
                    const cells = [...notebook.cells];
                    cells.forEach((cell, idx) => {
                        if (cell.cell_type !== 'markdown') return;
                        const src = getSource(cell);
                        let bc = 0;
                        const patched = src.replace(/_{3,}/g, () => {
                            const val = fillBlanksRef.current[idx + '-' + bc];
                            bc++;
                            return val || '___';
                        });
                        if (patched !== src) {
                            cells[idx] = { ...cells[idx], source: patched.split('\n').map((l,i,a) => i < a.length-1 ? l+'\n' : l) };
                        }
                    });
                    nb = { ...notebook, cells };
                    setNotebook(nb);
                }
                try {
                    await fetch(`/api/lab/${labId}/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(nb)
                    });
                    setDirty(false);
                } catch (e) { alert('Save failed'); }
            };

            const saveNotebookAs = async (newName) => {
                try {
                    await fetch(`/api/lab/${newName}/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(notebook)
                    });
                    setShowSaveAs(false);
                    setDirty(false);
                } catch (e) { alert('Save failed'); }
            };

            const restartKernel = async () => {
                if (!confirm('Restart kernel? All variables will be lost.')) return;
                setStatus('loading');
                setOutputs({});
                if (kernel === 'pyodide') {
                    try {
                        const py = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
                        await py.loadPackage(['numpy', 'pandas', 'matplotlib', 'scikit-learn']);
                        setPyodide(py);
                        setStatus('ready');
                    } catch { setStatus('error'); }
                } else {
                    try {
                        await fetch('/api/kernel/restart', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ lab_id: labId })
                        });
                        setStatus('ready');
                    } catch { setStatus('error'); }
                }
            };

            const switchKernel = async (newKernel) => {
                if (newKernel === kernel) return;
                setKernel(newKernel);
                setStatus('loading');
                setOutputs({});
                if (newKernel === 'pyodide') {
                    try {
                        const py = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
                        await py.loadPackage(['numpy', 'pandas', 'matplotlib', 'scikit-learn']);
                        setPyodide(py);
                        setStatus('ready');
                    } catch { setStatus('error'); }
                } else {
                    try {
                        await fetch('/api/kernel/start', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({ lab_id: labId })
                        });
                        setStatus('ready');
                    } catch { setStatus('error'); }
                }
            };

            const sendAIPrompt = async (promptOverride) => {
                const prompt = promptOverride || aiPrompt;
                if (!prompt.trim() || aiLoading) return;
                if (promptOverride) setAiPrompt(promptOverride);
                setAiLoading(true);
                setAiResponse('');
                try {
                    const res = await fetch('/api/openai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            model: aiModel,
                            messages: [{ role: 'user', content: prompt }]
                        })
                    });
                    const data = await res.json();
                    if (data.error) {
                        setAiResponse('Error: ' + (data.error.message || data.error));
                    } else {
                        setAiResponse(data.choices?.[0]?.message?.content || JSON.stringify(data, null, 2));
                    }
                } catch (err) {
                    setAiResponse('Error: ' + err.message);
                }
                setAiLoading(false);
            };

            const sendCellToAI = (idx) => {
                const cell = notebook.cells[idx];
                const src = Array.isArray(cell.source) ? cell.source.join('') : (cell.source || '');
                if (!src.trim()) return;
                setShowAIPanel(true);
                sendAIPrompt(src);
            };

            const handleExerciseSubmit = async (cellIdx, buttonEl) => {
                // Disable button
                buttonEl.disabled = true;
                const origText = buttonEl.textContent;
                buttonEl.textContent = 'Submitting...';

                try {
                    // Find exercise boundaries: walk backward to find any ## heading
                    let headerIdx = cellIdx;
                    for (let i = cellIdx; i >= 0; i--) {
                        const src = getSource(notebook.cells[i]);
                        if (/^## /m.test(src)) {
                            headerIdx = i;
                            break;
                        }
                    }

                    // Collect exercise context (all cell sources in range)
                    const contextParts = [];
                    for (let i = headerIdx; i <= cellIdx; i++) {
                        const src = getSource(notebook.cells[i]).replace(/<!--\s*submit-exercise\s*-->/g, '');
                        contextParts.push(src);
                    }
                    const exerciseContext = contextParts.join('\n\n');

                    // Collect student answers from fill-blank inputs in the range
                    const studentAnswers = [];
                    for (let i = headerIdx; i <= cellIdx; i++) {
                        let bc = 0;
                        const src = getSource(notebook.cells[i]);
                        const blanks = src.match(/_{3,}/g);
                        if (!blanks) continue;
                        blanks.forEach(() => {
                            const key = i + '-' + bc;
                            const val = fillBlanksRef.current[key];
                            if (val && val.trim()) {
                                studentAnswers.push('Cell ' + i + ', blank ' + (bc + 1) + ': ' + val);
                            }
                            bc++;
                        });
                    }

                    const systemMsg = 'You are an AI teaching assistant for a Prompt Engineering Masterclass. A student completed an exercise on the CRAFT framework. Provide your own model answers, then evaluate the student\'s answers with specific feedback. Format your response as markdown.';
                    const userMsg = 'Here is the exercise:\n\n' + exerciseContext +
                        '\n\n---\n\nStudent\'s Answers:\n' + (studentAnswers.length > 0 ? studentAnswers.join('\n') : '(No answers provided yet)') +
                        '\n\nPlease provide:\n1) Your model answer for each question\n2) Feedback on each student answer (what\'s good, what to improve)\n3) Overall assessment';

                    // Call GPT API
                    const res = await fetch('/api/openai/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            model: aiModel,
                            messages: [
                                { role: 'system', content: systemMsg },
                                { role: 'user', content: userMsg }
                            ]
                        })
                    });
                    const data = await res.json();
                    if (data.error) {
                        throw new Error(data.error.message || data.error);
                    }
                    const gptResponse = data.choices?.[0]?.message?.content || 'No response received.';

                    // Insert or replace AI review cell
                    const reviewCell = {
                        cell_type: 'markdown',
                        source: '## \u{1F916} AI Review\n\n' + gptResponse,
                        metadata: { ai_review: true }
                    };
                    const cells = [...notebook.cells];

                    // Check if next cell is already an AI review (prevent duplicates)
                    if (cells[cellIdx + 1]?.metadata?.ai_review) {
                        cells[cellIdx + 1] = reviewCell;
                    } else {
                        cells.splice(cellIdx + 1, 0, reviewCell);
                    }
                    setNotebook({ ...notebook, cells });

                    // Re-index rendered cells and mark the new review cell as rendered
                    const newRendered = {};
                    cells.forEach((c, i) => {
                        if (c.cell_type === 'markdown') newRendered[i] = true;
                    });
                    setRenderedCells(newRendered);

                } catch (err) {
                    alert('AI Review error: ' + err.message);
                }

                // Re-enable button
                buttonEl.textContent = origText;
                buttonEl.disabled = false;
            };

            const insertAIResponse = () => {
                if (!aiResponse) return;
                const newCell = { cell_type: 'markdown', metadata: {}, source: [aiResponse] };
                const newCells = [...notebook.cells];
                newCells.splice(selected + 1, 0, newCell);
                setNotebook({ ...notebook, cells: newCells });
                setSelected(selected + 1);
                setRenderedCells(prev => {
                    const updated = {};
                    Object.keys(prev).forEach(k => {
                        const ki = parseInt(k);
                        updated[ki > selected ? ki + 1 : ki] = prev[k];
                    });
                    updated[selected + 1] = true;
                    return updated;
                });
            };

            const copyAIResponse = () => {
                navigator.clipboard.writeText(aiResponse).catch(() => {});
            };

            if (!notebook) return <div className="loading-screen"><div className="spinner"></div>Loading notebook...</div>;

            return (
                <>
                    {showSaveAs && (
                        <div className="modal-overlay" onClick={() => setShowSaveAs(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()}>
                                <h2>Save Notebook As</h2>
                                <div className="form-group">
                                    <label>New notebook name</label>
                                    <input type="text" value={saveAsName} onChange={e => setSaveAsName(e.target.value)} />
                                </div>
                                <div style={{display:'flex',gap:'8px',marginTop:'16px'}}>
                                    <button className="btn btn-primary" onClick={() => saveNotebookAs(saveAsName)}>Save</button>
                                    <button className="btn btn-ghost" onClick={() => setShowSaveAs(false)}>Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}
                    {showShortcuts && (
                        <div className="modal-overlay" onClick={() => setShowShortcuts(false)}>
                            <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth:'600px'}}>
                                <h2 style={{marginBottom:'16px'}}> Keyboard Shortcuts</h2>
                                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'24px'}}>
                                    <div>
                                        <h3 style={{fontSize:'0.875rem',color:'#38bdf8',marginBottom:'8px'}}>Command Mode (Esc)</h3>
                                        <div style={{fontSize:'0.8rem',lineHeight:'1.8'}}>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Enter</kbd> Enter edit mode</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>/</kbd> or <kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>J/K</kbd> Navigate</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>A</kbd> Insert cell above</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>B</kbd> Insert cell below</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>X</kbd> Cut cell</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>C</kbd> Copy cell</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>V</kbd> Paste cell</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>DD</kbd> Delete cell</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>M</kbd> Change to Markdown</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Y</kbd> Change to Code</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>H</kbd> Toggle toolbar</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Shift+K</kbd> Toggle key panel</div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 style={{fontSize:'0.875rem',color:'#eab308',marginBottom:'8px'}}>Edit Mode</h3>
                                        <div style={{fontSize:'0.8rem',lineHeight:'1.8'}}>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Esc</kbd> Enter command mode</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Ctrl+Enter</kbd> Run/render cell</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Shift+Enter</kbd> Run & move next</div>
                                        </div>
                                        <h3 style={{fontSize:'0.875rem',color:'#94a3b8',marginBottom:'8px',marginTop:'16px'}}>Global</h3>
                                        <div style={{fontSize:'0.8rem',lineHeight:'1.8'}}>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Ctrl+S</kbd> Save</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Ctrl+Shift+S</kbd> Save As</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>Shift+R</kbd> Restart kernel</div>
                                            <div><kbd style={{background:'#334155',padding:'2px 6px',borderRadius:'3px',marginRight:'8px'}}>?</kbd> Show this help</div>
                                        </div>
                                    </div>
                                </div>
                                <div style={{marginTop:'20px',textAlign:'center'}}>
                                    <button className="btn btn-primary" onClick={() => setShowShortcuts(false)}>Close</button>
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="content-header">
                        <div className="content-title">
                            <span></span> Interactive Lab {dirty && <span style={{color:'#eab308',fontSize:'0.75rem'}}>(unsaved)</span>}
                        </div>
                        <div className="content-actions">
                            <select className="course-select" style={{width:'auto',minWidth:'180px'}} value={kernel} onChange={e => switchKernel(e.target.value)}>
                                {availableKernels.map(k => (
                                    <option key={k.id} value={k.id}>{k.icon} {k.name}</option>
                                ))}
                            </select>
                            <div className="kernel-status">
                                <div className={`kernel-dot ${status}`}></div>
                                {status === 'ready' ? 'Ready' : status === 'loading' ? 'Loading...' : 'Error'}
                            </div>
                            <button className={`ai-panel-toggle ${showAIPanel ? 'active' : ''}`} onClick={() => setShowAIPanel(!showAIPanel)} title="Test your prompts with AI">
                                <span></span> Test Prompt
                            </button>
                            <button className="btn btn-ghost" onClick={onBack}> Back</button>
                        </div>
                    </div>
                    <div className="notebook-toolbar-container">
                        <div className="toolbar-toggle" onClick={() => setShowToolbar(!showToolbar)}>
                            <div className="toolbar-toggle-label">
                                <span className={`toolbar-toggle-arrow ${!showToolbar ? 'collapsed' : ''}`}></span>
                                <span>Toolbar</span>
                                <span style={{padding:'2px 8px',borderRadius:'4px',background: commandMode ? '#22c55e' : '#eab308',color:'#0f172a',fontWeight:'600',fontSize:'0.65rem'}}>
                                    {commandMode ? 'COMMAND' : 'EDIT'}
                                </span>
                            </div>
                            <div style={{fontSize:'0.65rem',color:'#475569'}}>
                                {showToolbar ? 'Click to hide' : 'Click to show'}  Press <kbd style={{background:'#334155',padding:'1px 4px',borderRadius:'2px'}}>?</kbd> for shortcuts
                            </div>
                        </div>
                        <div className={`notebook-toolbar ${!showToolbar ? 'hidden' : ''}`}>
                            {/* Run Group */}
                            <div className="toolbar-group">
                                <button className="toolbar-btn success" onClick={() => executeCell(selected)} disabled={status !== 'ready' || running !== null} title="Run Cell (Ctrl+Enter)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Run</span>
                                </button>
                                <button className="toolbar-btn" onClick={runAllCells} disabled={status !== 'ready' || running !== null} title="Run All Cells">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Run All</span>
                                </button>
                                <button className="toolbar-btn" onClick={restartKernel} title="Restart Kernel (Shift+R)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Restart</span>
                                </button>
                                <button className="toolbar-btn" onClick={() => { restartKernel().then(runAllCells); }} disabled={status !== 'ready'} title="Restart & Run All">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Reset+Run</span>
                                </button>
                            </div>

                            <div className="toolbar-divider"></div>

                            {/* Cell Operations */}
                            <div className="toolbar-group">
                                <button className="toolbar-btn" onClick={() => insertCell(selected, 'code')} title="Insert Cell Above (A)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Above</span>
                                </button>
                                <button className="toolbar-btn" onClick={() => { insertCell(selected + 1, 'code'); setSelected(selected + 1); }} title="Insert Cell Below (B)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Below</span>
                                </button>
                                <button className="toolbar-btn danger" onClick={() => deleteCell(selected)} disabled={notebook.cells.length <= 1} title="Delete Cell (DD)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Delete</span>
                                </button>
                            </div>

                            <div className="toolbar-divider"></div>

                            {/* Clipboard */}
                            <div className="toolbar-group">
                                <button className="toolbar-btn" onClick={cutCell} title="Cut Cell (X)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Cut</span>
                                </button>
                                <button className="toolbar-btn" onClick={copyCell} title="Copy Cell (C)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Copy</span>
                                </button>
                                <button className="toolbar-btn" onClick={pasteCell} disabled={!clipboard} title="Paste Cell (V)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Paste</span>
                                </button>
                            </div>

                            <div className="toolbar-divider"></div>

                            {/* Move */}
                            <div className="toolbar-group">
                                <button className="toolbar-btn" onClick={moveCellUp} disabled={selected === 0} title="Move Cell Up">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Up</span>
                                </button>
                                <button className="toolbar-btn" onClick={moveCellDown} disabled={selected >= notebook.cells.length - 1} title="Move Cell Down">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Down</span>
                                </button>
                            </div>

                            <div className="toolbar-divider"></div>

                            {/* Cell Type */}
                            <div className="toolbar-group">
                                <button className={`toolbar-btn ${notebook.cells[selected]?.cell_type === 'code' ? 'primary' : ''}`} onClick={() => changeCellType(selected, 'code')} title="Code Cell (Y)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Code</span>
                                </button>
                                <button className={`toolbar-btn ${notebook.cells[selected]?.cell_type === 'markdown' ? 'primary' : ''}`} onClick={() => changeCellType(selected, 'markdown')} title="Markdown Cell (M)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Markdown</span>
                                </button>
                            </div>

                            <div className="toolbar-divider"></div>

                            {/* Save */}
                            <div className="toolbar-group">
                                <button className="toolbar-btn" onClick={saveNotebook} title="Save (Ctrl+S)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Save</span>
                                </button>
                                <button className="toolbar-btn" onClick={() => setShowSaveAs(true)} title="Save As (Ctrl+Shift+S)">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Save As</span>
                                </button>
                            </div>

                            <div className="toolbar-divider"></div>

                            {/* Clear */}
                            <div className="toolbar-group">
                                <button className="toolbar-btn" onClick={() => setOutputs({})} title="Clear All Outputs">
                                    <span className="toolbar-btn-icon"></span>
                                    <span className="toolbar-btn-label">Clear</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Graphical Keyboard Shortcuts Panel */}
                    <div className={`key-panel-container ${showKeyPanel ? 'expanded' : 'collapsed'}`}>
                        <div className="key-panel-toggle" onClick={() => setShowKeyPanel(!showKeyPanel)}>
                            <div style={{display:'flex',alignItems:'center',gap:'8px',fontSize:'0.7rem',color:'#64748b'}}>
                                <span style={{transition:'transform 0.2s',transform: showKeyPanel ? 'rotate(0deg)' : 'rotate(-90deg)'}}></span>
                                <span> Keyboard Shortcuts</span>
                                <span style={{padding:'2px 8px',borderRadius:'4px',background: commandMode ? '#22c55e' : '#eab308',color:'#0f172a',fontWeight:'600',fontSize:'0.6rem'}}>
                                    {commandMode ? 'COMMAND' : 'EDIT'}
                                </span>
                            </div>
                            <div style={{fontSize:'0.6rem',color:'#475569'}}>
                                Press <span className="key-cap small">?</span> for full reference
                            </div>
                        </div>
                        <div className={`key-panel ${!showKeyPanel ? 'hidden' : ''}`}>
                            {/* Navigation */}
                            <div className="key-group">
                                <div className="key-group-title">Navigate</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-cap"></div>
                                        <div className="key-label">Up</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-cap"></div>
                                        <div className="key-label">Down</div>
                                    </div>
                                </div>
                            </div>

                            {/* Mode */}
                            <div className="key-group">
                                <div className="key-group-title">Mode</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-cap warning wide">Enter</div>
                                        <div className="key-label">Edit</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-cap primary wide">Esc</div>
                                        <div className="key-label">Command</div>
                                    </div>
                                </div>
                            </div>

                            {/* Run */}
                            <div className="key-group">
                                <div className="key-group-title">Execute</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-combo">
                                            <div className="key-cap small">Ctrl</div>
                                            <span className="key-plus">+</span>
                                            <div className="key-cap success small"></div>
                                        </div>
                                        <div className="key-label">Run</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-combo">
                                            <div className="key-cap small"></div>
                                            <span className="key-plus">+</span>
                                            <div className="key-cap success small"></div>
                                        </div>
                                        <div className="key-label">Run+Next</div>
                                    </div>
                                </div>
                            </div>

                            {/* Insert */}
                            <div className="key-group">
                                <div className="key-group-title">Insert Cell</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-cap">A</div>
                                        <div className="key-label">Above</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-cap">B</div>
                                        <div className="key-label">Below</div>
                                    </div>
                                </div>
                            </div>

                            {/* Clipboard */}
                            <div className="key-group">
                                <div className="key-group-title">Clipboard</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-cap">X</div>
                                        <div className="key-label">Cut</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-cap">C</div>
                                        <div className="key-label">Copy</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-cap">V</div>
                                        <div className="key-label">Paste</div>
                                    </div>
                                </div>
                            </div>

                            {/* Cell Type */}
                            <div className="key-group">
                                <div className="key-group-title">Cell Type</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-cap primary">M</div>
                                        <div className="key-label">Markdown</div>
                                    </div>
                                    <div className="key-item">
                                        <div className="key-cap primary">Y</div>
                                        <div className="key-label">Code</div>
                                    </div>
                                </div>
                            </div>

                            {/* Delete */}
                            <div className="key-group">
                                <div className="key-group-title">Delete</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-combo">
                                            <div className="key-cap" style={{background:'linear-gradient(180deg, #dc2626 0%, #b91c1c 100%)',borderColor:'#ef4444'}}>D</div>
                                            <div className="key-cap" style={{background:'linear-gradient(180deg, #dc2626 0%, #b91c1c 100%)',borderColor:'#ef4444'}}>D</div>
                                        </div>
                                        <div className="key-label">Delete</div>
                                    </div>
                                </div>
                            </div>

                            {/* Save */}
                            <div className="key-group">
                                <div className="key-group-title">Save</div>
                                <div className="key-group-keys">
                                    <div className="key-item">
                                        <div className="key-combo">
                                            <div className="key-cap small">Ctrl</div>
                                            <span className="key-plus">+</span>
                                            <div className="key-cap small">S</div>
                                        </div>
                                        <div className="key-label">Save</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="notebook-container" ref={containerRef}>
                        {notebook.cells.map((cell, idx) => (
                            <div key={idx} className={`cell ${selected === idx ? 'selected' : ''}`} onClick={() => setSelected(idx)}>
                                <div className="cell-header">
                                    <div className="cell-controls">
                                        <span className="cell-type-label">[{idx + 1}] {cell.cell_type}</span>
                                        {running === idx && <span style={{color:'#eab308',marginLeft:'8px'}}>Running...</span>}
                                    </div>
                                    <div style={{display:'flex',gap:'4px',alignItems:'center'}}>
                                        <select
                                            className="toolbar-btn"
                                            style={{padding:'2px 4px',fontSize:'0.65rem'}}
                                            value={cell.cell_type}
                                            onChange={(e) => { e.stopPropagation(); changeCellType(idx, e.target.value); }}
                                        >
                                            <option value="code">Code</option>
                                            <option value="markdown">Markdown</option>
                                            <option value="raw">Raw</option>
                                        </select>
                                        <button
                                            className="cell-run-btn"
                                            onClick={(e) => { e.stopPropagation(); executeCell(idx); }}
                                            disabled={cell.cell_type === 'code' && (status !== 'ready' || running !== null)}
                                            title={cell.cell_type === 'code' ? 'Run Code (Ctrl+Enter)' : 'Render Markdown (Ctrl+Enter)'}
                                        >
                                            {running === idx ? '' : cell.cell_type === 'markdown' ? '' : ''}
                                        </button>
                                        {cell.cell_type === 'markdown' && (
                                            <button
                                                className="cell-ai-btn"
                                                onClick={(e) => { e.stopPropagation(); sendCellToAI(idx); }}
                                                disabled={aiLoading}
                                                title="Send cell content to AI for testing"
                                            >
                                                {aiLoading ? '' : ''}
                                            </button>
                                        )}
                                    </div>
                                </div>
                                {cell.cell_type === 'markdown' && renderedCells[idx] ? (
                                    <div
                                        className={'cell-content markdown-rendered' + (cell.metadata?.ai_review ? ' ai-review-cell' : '')}
                                        style={{padding:'16px',background: cell.metadata?.ai_review ? undefined : '#0f172a',cursor:'default',minHeight:'60px'}}
                                        onDoubleClick={(e) => {
                                            if (e.target.closest('input, select, textarea, button, a')) return;
                                            flushFillBlanks(idx);
                                            enterEditMode(idx);
                                        }}
                                        onInput={(e) => {
                                            if (e.target.classList.contains('fill-blank')) {
                                                fillBlanksRef.current[e.target.dataset.fillKey] = e.target.value;
                                                setDirty(true);
                                            }
                                        }}
                                        onClick={(e) => {
                                            if (e.target.classList.contains('exercise-submit-btn')) {
                                                handleExerciseSubmit(idx, e.target);
                                            }
                                        }}
                                        dangerouslySetInnerHTML={{ __html: renderMarkdownToHtml(getSource(cell), idx, fillBlanksRef.current) }}
                                    />
                                ) : (
                                    <div className="cell-content">
                                        <textarea
                                            value={getSource(cell)}
                                            onChange={e => setSource(idx, e.target.value)}
                                            spellCheck="false"
                                            onFocus={() => setCommandMode(false)}
                                            onBlur={() => {
                                                setCommandMode(true);
                                                if (cell.cell_type === 'markdown') {
                                                    setRenderedCells(prev => ({ ...prev, [idx]: true }));
                                                }
                                            }}
                                            placeholder={cell.cell_type === 'markdown' ? 'Enter markdown text...' : 'Enter Python code...'}
                                        />
                                    </div>
                                )}
                                {cell.cell_type === 'code' && outputs[idx] && (
                                    <div className={`cell-output ${outputs[idx].error ? 'error' : ''}`}>
                                        <pre>{outputs[idx].output}</pre>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                    <div className={`ai-chat-panel ${showAIPanel ? '' : 'collapsed'}`}>
                        <div className="ai-chat-header">
                            <div className="ai-chat-header-title">
                                <span></span> Test Your Prompt
                            </div>
                            <div className="ai-chat-header-actions">
                                <select className="ai-chat-model-select" value={aiModel} onChange={e => setAiModel(e.target.value)}>
                                    <option value="gpt-4o">GPT-4o</option>
                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                </select>
                                <button className="ai-chat-close-btn" onClick={() => setShowAIPanel(false)}>Close</button>
                            </div>
                        </div>
                        <div className="ai-chat-body">
                            <div className="ai-chat-input-area">
                                <textarea
                                    className="ai-chat-textarea"
                                    value={aiPrompt}
                                    onChange={e => setAiPrompt(e.target.value)}
                                    placeholder="Paste or type your prompt here, then click Send to test it with AI..."
                                    onKeyDown={e => { if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); e.stopPropagation(); sendAIPrompt(); } }}
                                />
                                <div className="ai-chat-send-row">
                                    <button className="ai-chat-send-btn" onClick={sendAIPrompt} disabled={aiLoading || !aiPrompt.trim()}>
                                        {aiLoading ? 'Sending...' : 'Send'}
                                    </button>
                                    <span style={{fontSize:'0.65rem',color:'#64748b'}}>Ctrl+Enter to send</span>
                                </div>
                            </div>
                            <div className="ai-chat-response-area">
                                <div className="ai-chat-response-header">
                                    <span>AI Response</span>
                                    {aiResponse && <>
                                        <button className="ai-chat-copy-btn" onClick={insertAIResponse}>Insert Below Cell</button>
                                        <button className="ai-chat-copy-btn" onClick={copyAIResponse}>Copy</button>
                                    </>}
                                </div>
                                <div className={`ai-chat-response ${!aiResponse && !aiLoading ? 'empty' : ''}`}>
                                    {aiLoading ? 'Generating response...' : aiResponse || 'Response will appear here'}
                                </div>
                            </div>
                        </div>
                    </div>
                </>
            );
        }

        // Main App
        function App() {
            const [user, setUser] = useState(null);
            const [showAuth, setShowAuth] = useState(false);
            const [authChecked, setAuthChecked] = useState(false);
            const [courses, setCourses] = useState([]);
            const [categories, setCategories] = useState([]);
            const [selectedCourse, setSelectedCourse] = useState(null);
            const [materials, setMaterials] = useState(null);
            const [selectedItem, setSelectedItem] = useState(null);
            const [runningLab, setRunningLab] = useState(null);
            const [loading, setLoading] = useState(true);
            const [initialLoad, setInitialLoad] = useState(true);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [courseDetail, setCourseDetail] = useState(null);
            const [topicPopup, setTopicPopup] = useState(null);
            const [notEnrolled, setNotEnrolled] = useState(false);
            const [showAdmin, setShowAdmin] = useState(false);
            const [courseInstructorNames, setCourseInstructorNames] = useState([]);

            // Parse URL on load to restore state
            const getStateFromUrl = () => {
                const path = window.location.pathname;
                const courseMatch = path.match(/^\/course\/([^\/]+)(?:\/item\/([^\/]+))?/);
                if (courseMatch) {
                    return { courseId: courseMatch[1], itemId: courseMatch[2], categoryId: null };
                }
                const categoryMatch = path.match(/^\/category\/([^\/]+)/);
                if (categoryMatch) {
                    return { courseId: null, itemId: null, categoryId: categoryMatch[1] };
                }
                return { courseId: null, itemId: null, categoryId: null };
            };

            // Update URL when state changes
            const updateUrl = (course, item, categoryId) => {
                let newPath = '/';
                if (course) {
                    newPath = `/course/${course.id}`;
                    if (item) newPath += `/item/${item.id}`;
                } else if (categoryId) {
                    newPath = `/category/${categoryId}`;
                }
                if (window.location.pathname !== newPath) {
                    window.history.pushState({}, '', newPath);
                }
            };

            useEffect(() => {
                fetch('/api/auth/me', { credentials: 'include' })
                    .then(res => res.json())
                    .then(data => { if (data.user) setUser(data.user); setAuthChecked(true); })
                    .catch(() => setAuthChecked(true));
            }, []);

            useEffect(() => {
                Promise.all([
                    fetch('/api/courses').then(res => res.json()),
                    fetch('/api/categories').then(res => res.json())
                ]).then(([coursesData, categoriesData]) => {
                    setCourses(coursesData);
                    setCategories(categoriesData);
                    setLoading(false);
                    // Restore state from URL on initial load
                    const urlState = getStateFromUrl();
                    if (initialLoad) {
                        if (urlState.courseId) {
                            const course = coursesData.find(c => c.id === urlState.courseId);
                            if (course) setSelectedCourse(course);
                        } else if (urlState.categoryId) {
                            const cat = categoriesData.find(c => c.id === urlState.categoryId);
                            if (cat) setSelectedCategory(cat);
                        }
                    }
                    setInitialLoad(false);
                });
            }, []);

            useEffect(() => {
                if (selectedCourse && user) {
                    setNotEnrolled(false);
                    fetch(`/api/course/${selectedCourse.id}/materials`, { credentials: 'include' })
                        .then(res => {
                            if (res.status === 403) {
                                return res.json().then(data => {
                                    if (data.error === 'not_enrolled') {
                                        setNotEnrolled(true);
                                        setMaterials(null);
                                    }
                                    return null;
                                });
                            }
                            return res.json();
                        })
                        .then(data => {
                            if (!data) return;
                            setMaterials(data);
                            // Restore selected item from URL
                            const urlState = getStateFromUrl();
                            if (urlState?.itemId) {
                                for (const section of Object.values(data)) {
                                    const item = section.items.find(i => i.id === urlState.itemId);
                                    if (item) { setSelectedItem(item); break; }
                                }
                            }
                        });
                } else if (selectedCourse && !user) {
                    setMaterials(null);
                    setNotEnrolled(false);
                }
            }, [selectedCourse, user]);

            // Fetch course detail for guest preview (not logged in OR not enrolled)
            useEffect(() => {
                if (selectedCourse && (!user || notEnrolled)) {
                    fetch(`/api/course/${selectedCourse.id}`)
                        .then(res => res.json())
                        .then(data => setCourseDetail(data));
                } else {
                    setCourseDetail(null);
                }
            }, [selectedCourse, user]);

            // Fetch assigned instructors when course changes
            useEffect(() => {
                if (selectedCourse) {
                    fetch(`/api/course/${selectedCourse.id}/instructors`)
                        .then(res => res.json())
                        .then(data => setCourseInstructorNames(data.map(i => i.full_name || i.username)))
                        .catch(() => setCourseInstructorNames([]));
                } else {
                    setCourseInstructorNames([]);
                }
            }, [selectedCourse]);

            // Update URL when state changes
            useEffect(() => {
                if (!initialLoad) {
                    updateUrl(selectedCourse, selectedItem);
                }
            }, [selectedCourse, selectedItem]);

            // Handle browser back/forward
            useEffect(() => {
                const handlePopState = () => {
                    const urlState = getStateFromUrl();
                    if (urlState.courseId) {
                        const course = courses.find(c => c.id === urlState.courseId);
                        if (course) setSelectedCourse(course);
                        setSelectedCategory(null);
                    } else if (urlState.categoryId) {
                        const cat = categories.find(c => c.id === urlState.categoryId);
                        setSelectedCategory(cat || null);
                        setSelectedCourse(null);
                        setSelectedItem(null);
                        setMaterials(null);
                    } else {
                        setSelectedCourse(null);
                        setSelectedItem(null);
                        setMaterials(null);
                        setSelectedCategory(null);
                    }
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, [courses, categories]);

            const handleLogout = async () => {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                setUser(null);
            };

            const handleItemClick = async (item) => {
                if (item.runnable && item.type === 'lab') {
                    if (!user) { setShowAuth(true); return; }
                    await fetch(`/api/lab/${item.id}/start`, { method: 'POST', credentials: 'include' });
                    setRunningLab(item.id);
                    setSelectedItem(null);
                } else if (item.external) {
                    window.open(`/content/${item.file}`, '_blank');
                } else {
                    setSelectedItem(item);
                    setRunningLab(null);
                }
            };

            const countItems = (type) => {
                if (!materials) return 0;
                let count = 0;
                Object.values(materials).forEach(s => s.items.forEach(i => { if (!type || i.type === type) count++; }));
                return count;
            };

            const navigateToCategory = (cat) => {
                setSelectedCategory(cat);
                setSelectedCourse(null);
                updateUrl(null, null, cat.id);
            };

            const navigateHome = () => {
                setSelectedCategory(null);
                setSelectedCourse(null);
                setSelectedItem(null);
                setMaterials(null);
                setCourseDetail(null);
                updateUrl(null, null, null);
            };

            if (!authChecked || loading) {
                return <div className="loading-screen"><div className="spinner"></div>Loading...</div>;
            }

            const UserControls = () => (
                <div className="user-menu">
                    {user ? (
                        <>
                            {user.role === 'instructor' && (
                                <button className="admin-btn" onClick={() => setShowAdmin(true)} title="Student Management">&#9881;</button>
                            )}
                            <div className="user-avatar">{user.username[0].toUpperCase()}</div>
                            <span className="user-name">{user.full_name || user.username}</span>
                            <button className="btn btn-ghost" onClick={handleLogout}>Logout</button>
                        </>
                    ) : (
                        <>
                            <span className="guest-label">Guest</span>
                            <button className="btn btn-ghost" onClick={() => setShowAuth(true)}>Login</button>
                        </>
                    )}
                </div>
            );

            return (
                <div className={`app ${selectedCourse && user && !notEnrolled ? 'with-sidebar' : ''}`}>
                    {showAuth && <AuthModal onLogin={(u) => { setUser(u); setShowAuth(false); }} onSkip={() => setShowAuth(false)} />}
                    {showAdmin && <AdminModal courses={courses} onClose={() => setShowAdmin(false)} />}

                    {topicPopup && (
                        <div className="modal-overlay" onClick={() => setTopicPopup(null)}>
                            <div className="modal topic-modal" onClick={e => e.stopPropagation()}>
                                <div className="topic-modal-header">
                                    <h2>{topicPopup.name}</h2>
                                    <button className="topic-modal-close" onClick={() => setTopicPopup(null)}>&times;</button>
                                </div>
                                <div className="topic-modal-body">{topicPopup.description}</div>
                            </div>
                        </div>
                    )}

                    {(!selectedCourse || !user) && (
                        <header className="header">
                            <div className="header-brand"><span></span> AI Elevate</div>
                            <div className="header-actions"><UserControls /></div>
                        </header>
                    )}

                    {selectedCourse && user && !notEnrolled && (
                        <aside className="sidebar">
                            <div className="sidebar-header">
                                <div className="sidebar-brand">
                                    <div className="sidebar-brand-text"><span></span> AI Elevate</div>
                                    <div style={{display:'flex',gap:'6px',alignItems:'center'}}>
                                        {user.role === 'instructor' && (
                                            <button className="admin-btn" onClick={() => setShowAdmin(true)} title="Student Management" style={{width:'28px',height:'28px',fontSize:'0.85rem'}}>&#9881;</button>
                                        )}
                                        <button className="back-home" onClick={() => { setSelectedCourse(null); setSelectedCategory(null); setMaterials(null); setSelectedItem(null); setRunningLab(null); setCourseDetail(null); updateUrl(null, null, null); }}>
                                             Home
                                        </button>
                                    </div>
                                </div>
                                <select className="course-select" value={selectedCourse.id} onChange={e => {
                                    const c = courses.find(x => x.id === e.target.value);
                                    if (c) { setSelectedCourse(c); setSelectedItem(null); setRunningLab(null); }
                                }}>
                                    {categories.map(cat => (
                                        <optgroup key={cat.id} label={`${cat.icon} ${cat.name}`}>
                                            {cat.courses.map(c => <option key={c.id} value={c.id}>{c.icon} {c.name}</option>)}
                                        </optgroup>
                                    ))}
                                </select>
                            </div>
                            <nav className="sidebar-nav">
                                {materials && Object.entries(materials).map(([key, section]) => (
                                    <div className="nav-section" key={key}>
                                        <div className="nav-section-title">{section.title}</div>
                                        {section.items.map(item => (
                                            <button
                                                key={item.id}
                                                className={`nav-item ${selectedItem?.id === item.id || runningLab === item.id ? 'active' : ''}`}
                                                onClick={() => handleItemClick(item)}
                                            >
                                                <span className="nav-item-icon">{icons[item.type]}</span>
                                                <span className="nav-item-label">{item.name}</span>
                                                <span className={`nav-badge badge-${item.type}`}>{item.type}</span>
                                                {item.runnable && <span className="nav-badge badge-run">run</span>}
                                                {item.printable && <span className="nav-badge badge-pdf">pdf</span>}
                                                {item.external && <span className="nav-badge badge-live">live</span>}
                                            </button>
                                        ))}
                                    </div>
                                ))}
                            </nav>
                            <div className="sidebar-footer">
                                <button className="download-all-btn" onClick={() => window.location.href = `/api/course/${selectedCourse.id}/download`}>
                                     Download All Materials
                                </button>
                            </div>
                        </aside>
                    )}

                    <main className="main">
                        {runningLab ? (
                            <NotebookViewer labId={runningLab} onBack={() => setRunningLab(null)} />
                        ) : selectedItem ? (
                            <>
                                <div className="content-header">
                                    <div className="content-title">
                                        <span>{icons[selectedItem.type]}</span>
                                        {selectedItem.name}
                                    </div>
                                    <div className="content-actions">
                                        {selectedItem.type === 'slides' && (
                                            <button className="btn btn-success" onClick={() => {
                                                const frame = document.querySelector('.content-frame');
                                                if (frame) {
                                                    const goFullscreen = frame.requestFullscreen || frame.webkitRequestFullscreen;
                                                    if (goFullscreen) {
                                                        goFullscreen.call(frame).then(() => {
                                                            frame.focus();
                                                            frame.contentWindow?.focus();
                                                        });
                                                    }
                                                }
                                            }}> Present</button>
                                        )}
                                        {selectedItem.printable && <button className="btn btn-ghost" onClick={() => document.querySelector('.content-frame')?.contentWindow?.print()}> Print</button>}
                                        <button className="btn btn-ghost" onClick={() => window.open(`/content/${selectedItem.file}`, '_blank')}> New Tab</button>
                                        <button className="btn btn-primary" onClick={() => setSelectedItem(null)}> Back</button>
                                    </div>
                                </div>
                                <div className="content-body">
                                    <iframe className="content-frame" src={`/content/${selectedItem.file}`} title={selectedItem.name} />
                                </div>
                            </>
                        ) : selectedCourse && (!user || notEnrolled) ? (
                            <div className="course-preview">
                                <button className="course-preview-back" onClick={() => { setSelectedCourse(null); setCourseDetail(null); setNotEnrolled(false); updateUrl(null, null, null); }}>
                                     Back
                                </button>
                                <div className="course-preview-header">
                                    <div className="course-preview-icon">{selectedCourse.icon}</div>
                                    <div>
                                        <div className="course-preview-title">{selectedCourse.name}</div>
                                    </div>
                                </div>
                                <div className="course-preview-description">{selectedCourse.description}</div>
                                {notEnrolled && (
                                    <div style={{background:'#1e293b',border:'1px solid #f59e0b',borderRadius:'8px',padding:'16px',margin:'16px 0',display:'flex',alignItems:'center',gap:'12px'}}>
                                        <span style={{fontSize:'1.5rem'}}></span>
                                        <div>
                                            <div style={{color:'#f59e0b',fontWeight:'600',marginBottom:'4px'}}>Guest Access Only</div>
                                            <div style={{color:'#94a3b8',fontSize:'0.875rem'}}>You are not enrolled in this course. Contact your instructor for access to materials and labs.</div>
                                        </div>
                                    </div>
                                )}
                                <div className="course-preview-meta">
                                    {selectedCourse.duration && (
                                        <span className="course-preview-badge"> {selectedCourse.duration}</span>
                                    )}
                                    {courseDetail && courseDetail.audience && (
                                        <span className="course-preview-audience-badge"> {courseDetail.audience}</span>
                                    )}
                                    {courseInstructorNames.length > 0 && (
                                        <span className="instructor-badge"> {courseInstructorNames.join(', ')}</span>
                                    )}
                                </div>
                                {courseDetail && courseDetail.goals && courseDetail.goals.length > 0 && (
                                    <div className="course-preview-goals">
                                        <div className="course-preview-section-title-new">
                                            <span className="section-icon"></span> What You'll Learn
                                        </div>
                                        <ul>
                                            {courseDetail.goals.map((goal, i) => (
                                                <li key={i}>{goal}</li>
                                            ))}
                                        </ul>
                                    </div>
                                )}
                                <div className="course-preview-prereqs">
                                    <span className="prereq-label"> Prerequisites:</span>
                                    {courseDetail && courseDetail.prerequisites ? (
                                        <span className="prereq-value">{courseDetail.prerequisites}</span>
                                    ) : (
                                        <span className="prereq-none">None  open to all levels!</span>
                                    )}
                                </div>
                                {courseDetail && courseDetail.syllabus && courseDetail.syllabus.length > 0 && (
                                    <div className="course-preview-syllabus">
                                        <div className="course-preview-section-title-new">
                                            <span className="section-icon"></span> Topics Covered
                                        </div>
                                        <div className="course-preview-syllabus-grid">
                                            {courseDetail.syllabus.map((topic, i) => (
                                                <span key={i} className="course-preview-syllabus-pill"
                                                    onClick={() => courseDetail.topic_descriptions && courseDetail.topic_descriptions[topic] &&
                                                        setTopicPopup({name: topic, description: courseDetail.topic_descriptions[topic]})}>{topic}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {courseDetail && courseDetail.sections && (
                                    <>
                                        <div className="course-preview-sections-title">Course Contents</div>
                                        <div className="course-preview-sections">
                                            {Object.entries(courseDetail.sections).map(([key, section]) => (
                                                <div key={key} className="course-preview-section">
                                                    <div className="course-preview-section-header">
                                                        <div className="course-preview-section-title">{section.title}</div>
                                                        <span className="course-preview-section-count">{section.items.length} item{section.items.length !== 1 ? 's' : ''}</span>
                                                    </div>
                                                    {section.items.map(item => (
                                                        <div key={item.id} className="course-preview-item">
                                                            <span className="course-preview-item-icon">{icons[item.type] || ''}</span>
                                                            <span>{item.name}</span>
                                                            <span className={`course-preview-item-type badge-${item.type}`}>{item.type}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                                <div className="course-preview-cta">
                                    {notEnrolled ? (
                                        <p style={{color:'#94a3b8'}}>You are viewing this course as a guest. Contact your instructor to get enrolled.</p>
                                    ) : (
                                        <>
                                            <p>Sign in to access all course materials, labs, and downloads.</p>
                                            <button className="btn btn-primary btn-lg" onClick={() => setShowAuth(true)}>
                                                Sign In to Access This Course
                                            </button>
                                        </>
                                    )}
                                </div>
                            </div>
                        ) : selectedCourse && user && !notEnrolled ? (
                            <div className="course-welcome">
                                <div className="course-welcome-icon">{selectedCourse.icon}</div>
                                <h2>{selectedCourse.name}</h2>
                                <p>{selectedCourse.description}</p>
                                {courseInstructorNames.length > 0 && (
                                    <p className="instructor-badge" style={{marginTop:'4px'}}> Instructor: {courseInstructorNames.join(', ')}</p>
                                )}
                                <p style={{fontSize: '0.875rem', color: '#64748b'}}>Select a material from the sidebar to get started.</p>
                                {materials && (
                                    <div className="stats-row">
                                        <div className="stat-box"><div className="stat-number">{countItems()}</div><div className="stat-label">Materials</div></div>
                                        <div className="stat-box"><div className="stat-number">{countItems('lab')}</div><div className="stat-label">Labs</div></div>
                                        <div className="stat-box"><div className="stat-number">{Object.keys(materials).length}</div><div className="stat-label">Sections</div></div>
                                    </div>
                                )}
                            </div>
                        ) : selectedCategory ? (
                            <div className="home">
                                <div className="category-page-header">
                                    <button className="back-button" onClick={navigateHome}> All Topics</button>
                                    <span className="category-page-icon">{selectedCategory.icon}</span>
                                    <div className="category-page-info">
                                        <div className="category-page-name">{selectedCategory.name}</div>
                                        {selectedCategory.description && <div className="category-page-desc">{selectedCategory.description}</div>}
                                    </div>
                                </div>
                                <div className="course-grid" style={{maxWidth:'1200px',margin:'0 auto'}}>
                                    {selectedCategory.courses.map(course => (
                                        <div key={course.id} className="course-card" onClick={() => { setSelectedCourse(courses.find(c => c.id === course.id)); setSelectedCategory(null); }}>
                                            <div className="course-card-icon">{course.icon}</div>
                                            <h3>{course.name}</h3>
                                            <p>{course.description}</p>
                                            {course.duration && <div className="course-card-duration">{course.duration}</div>}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="home">
                                <div className="home-hero">
                                    <div className="home-hero-icon"></div>
                                    <h1>AI Elevate</h1>
                                    <p className="home-tagline">Professional AI & Technology Training</p>
                                    <p style={{marginTop: '24px', maxWidth: '500px'}}>
                                        Access interactive courses, hands-on labs, and comprehensive learning materials
                                        to advance your skills in AI, Python, and cloud technologies.
                                    </p>
                                    {!user && (
                                        <div className="home-cta">
                                            <button className="btn btn-primary btn-lg" onClick={() => setShowAuth(true)}>
                                                Sign In to Access Courses
                                            </button>
                                            <p style={{marginTop: '16px', fontSize: '0.875rem', color: '#64748b'}}>
                                                Or <button style={{background:'none',border:'none',color:'#38bdf8',cursor:'pointer',textDecoration:'underline'}} onClick={() => setShowAuth(true)}>create an account</button> to get started
                                            </p>
                                        </div>
                                    )}
                                    {user && (
                                        <p style={{marginTop: '24px', color: '#94a3b8'}}>Welcome back, {user.full_name || user.username}! Select a course below to get started.</p>
                                    )}
                                </div>
                                <div className="topic-grid">
                                    {categories.map(cat => (
                                        <div key={cat.id} className="topic-card" onClick={() => navigateToCategory(cat)}>
                                            <div className="topic-card-icon">{cat.icon}</div>
                                            <div className="topic-card-name">{cat.name}</div>
                                            {cat.description && <div className="topic-card-description">{cat.description}</div>}
                                            <span className="topic-card-count">{cat.courses.length} course{cat.courses.length !== 1 ? 's' : ''}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
